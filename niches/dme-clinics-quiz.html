<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DME Clinic & Provider Growth Quiz | TurnClicksToClients</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Basic styles adapted */
        body { font-family: 'Lato', sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f4; }
        .quiz-page-container { padding-top: 20px; padding-bottom: 40px; }
        .quiz-container { max-width: 850px; margin: 20px auto; padding: 30px 40px; background-color: #fff; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; }
        .quiz-hook h1 { font-family: 'Montserrat', sans-serif; font-size: clamp(1.8em, 4vw, 2.4em); color: #0056b3; margin-bottom: 0.5em; }
        .quiz-hook p.subheadline { font-size: clamp(1em, 2vw, 1.15em); color: #555; margin-bottom: 30px; max-width: 650px; margin-left: auto; margin-right: auto; }
        .quiz-benefits-intro { margin: 30px 0 40px 0; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; text-align: left; }
        .benefit-block { background-color: #f9f9f9; padding: 18px; border-radius: 8px; border: 1px solid #e0e0e0; border-left: 4px solid #007bff; flex: 1; min-width: 230px; }
        .benefit-block:nth-child(2) { border-left-color: #28a745; }
        .benefit-block:nth-child(3) { border-left-color: #ffc107; }
        .benefit-block h3 { font-family: 'Montserrat', sans-serif; font-size: 1.15em; color: #333; margin-bottom: 8px; }
        .benefit-block p { font-size: 0.9em; color: #666; line-height: 1.5; }
        .progress-bar-container { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; margin-bottom: 30px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: #28a745; border-radius: 5px; transition: width 0.4s ease; }
        #quiz-area { background-color: #fdfdfd; border: 1px solid #e9ecef; border-radius: 8px; padding: 30px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .quiz-question h2 { font-family: 'Montserrat', sans-serif; font-size: clamp(1.3em, 3vw, 1.7em); color: #2c3e50; margin-bottom: 30px; line-height: 1.4; }
        .quiz-answers ul { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .quiz-answers li { margin-bottom: 12px; }
        .answer-btn { display: block; width: 100%; padding: 15px; background-color: #007bff; color: white; border: 1px solid #007bff; border-radius: 5px; font-size: 1.05em; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; text-align: left; }
        .answer-btn:hover { background-color: #0056b3; border-color: #0056b3; }
        .answer-btn.selected { background-color: #004085; border-color: #00376e; color: #fff; }
        .quiz-navigation .cta-button { margin-top: 15px; }
        #quiz-result { padding: 20px; background-color: #e9f5ff; border: 1px solid #b8d6f0; border-radius: 5px; text-align: center; margin-top: 20px; }
        #quiz-result h3 { color: #0056b3; margin-bottom: 10px;}
        #quiz-result p { color: #333; }
        #lead-capture-form { margin-top: 30px; padding: 30px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #cce5ff; text-align: left; }
        #lead-capture-form h3 { font-family: 'Montserrat', sans-serif; text-align: center; color: #0056b3; margin-bottom: 15px; font-size: 1.5em; }
        #lead-capture-form p { text-align: center; color: #555; margin-bottom: 25px; font-size: 1.05em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 0.9em; }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"] { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .form-group input:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 2px rgba(0,123,255,.25);}
        #lead-capture-form .cta-button { width: 100%; padding: 12px; font-size: 1.2em; margin-top: 10px; background-color: #28a745; }
        #lead-capture-form .cta-button:hover { background-color: #1e7e34; }
        .privacy-note { font-size: 0.8em; color: #777; text-align: center; margin-top: 15px; }

        /* Field explanation styling */
        .field-explanation {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            margin-bottom: 0;
            font-style: italic;
        }
    </style>

    <script src="/tracking.js"></script>
      <link rel="stylesheet" href="../mobile_optimization.css">
    <link rel="stylesheet" href="../hamburger_fix.css">
    <link rel="stylesheet" href="../chat_widget_improvements.css">
    <link rel="stylesheet" href="../hamburger_clickable_fix.css">
</head>
<body>
    <header>
        <nav aria-label="Main Navigation">
            <div class="logo"><a href="../index.html" style="color: inherit; text-decoration: none;">TurnClicksToClients.com</a></div>
            <button class="hamburger" aria-label="Open navigation" aria-expanded="false" aria-controls="main-nav" style="display:none;">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul id="main-nav">
                <li style="margin-right: 8px;"><a href="../index.html">Home</a></li>
                <li style="margin-right: 8px;"><a href="../about.html">About Us</a></li>
                <li class="dropdown-parent" style="margin-right: 8px;">
                    <a href="../index.html#ideal-clients">Clients We Serve <span class="dropdown-arrow">â–¼</span></a>
                    <ul class="dropdown-menu">
                        <li><a href="child-care-centers.html">Child Care Centers</a></li>
                        <li><a href="cosmetic-dentists.html">Cosmetic Dentists</a></li>
                        <li><a href="pmu-artists.html">PMU Artists</a></li>
                        <li><a href="non-surgical-body-contouring.html">Non-Surgical Body Contouring</a></li>
                        <li><a href="weight-loss-clinics.html">Weight Loss Clinics</a></li>
                        <li><a href="high-end-chiropractors.html">High-End Chiropractors</a></li>
                        <li><a href="sleep-apnea-snoring-clinics.html">Sleep Apnea & Snoring Clinics</a></li>
                        <li><a href="hearing-aid-audiology-clinics.html">Hearing Aid & Audiology</a></li>
                        <li><a href="dme-clinics.html">DME Clinics</a></li>
                    </ul>
                </li>
                <li style="margin-right: 8px;"><a href="../index.html#core-offer">Our Offer</a></li>
                <li style="margin-right: 8px;"><a href="../index.html#guarantee">Guarantee</a></li>
                <li><a href="../index.html#cta-contact" class="cta-button nav-cta">Get Started</a></li>
            </ul>
        </nav>
    </header>

    <div class="quiz-page-container">
        <div class="quiz-container">
            <div class="quiz-hook">
                <h1>Optimize Your DME Operations: The DME Provider Growth Quiz</h1>
                <p class="subheadline">
                   Assess your Durable Medical Equipment business to identify opportunities for stronger referral relationships, streamlined fulfillment, and sustainable growth in a competitive market.
                </p>
            </div>

            <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <div id="quiz-area">
                <div class="quiz-benefits-intro" id="quiz-benefits-intro">
                    <div class="benefit-block">
                        <h3>Strengthen Referral Networks</h3>
                        <p>Learn how to build and maintain robust relationships with physicians, hospitals, and clinics for consistent patient referrals.</p>
                    </div>
                    <div class="benefit-block">
                        <h3>Streamline Operations</h3>
                        <p>Discover ways to improve inventory management, order fulfillment, billing, and compliance for greater efficiency.</p>
                    </div>
                    <div class="benefit-block">
                        <h3>Expand Market Reach</h3>
                        <p>Uncover strategies to grow your DME business by reaching new patient populations and exploring new product lines.</p>
                    </div>
                </div>
                <button class="cta-button" id="start-quiz-btn" onclick="startQuiz()">Start the Quiz &rarr;</button>

                <div id="quiz-question" class="quiz-question" style="display:none;">
                    <h2></h2>
                </div>
                <div id="quiz-answers" class="quiz-answers" style="display:none;">
                    <ul></ul>
                </div>
                <div class="quiz-navigation" style="display:none;">
                    <button id="next-question-btn" class="cta-button" onclick="nextQuestion()" style="display:none;">Next Question</button>
                </div>
            </div>

            <div id="lead-capture-form" style="display:none;">
                <h3>Unlock Your DME Business Growth Potential!</h3>
                <p>Provide your details to receive your personalized DME Provider growth assessment and key strategic recommendations.</p>
                <form onsubmit="event.preventDefault(); handleLeadSubmit();">
                    <div class="form-group">
                        <label for="first-name">First Name:</label>
                        <input type="text" id="first-name" name="first-name" required>
                    </div>
                    <div class="form-group">
                        <label for="last-name">Last Name:</label>
                        <input type="text" id="last-name" name="last-name" required>
                    </div>
                    <div class="form-group">
                        <label for="business-name">Business Name:</label>
                        <input type="text" id="business-name" name="business-name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number:</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <button type="submit" class="cta-button">See My DME Growth Plan!</button>
                </form>
                <p class="privacy-note">We respect your privacy. Your information is kept confidential.</p>
            </div>

            <div id="quiz-result" style="display:none;">
                <h3>Analyzing Your DME Business Growth Potential...</h3>
                <p>Just a moment while we tailor your strategic assessment.</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-main container">
            <div class="footer-column footer-info">
                <h3>TurnClicksToClients.com</h3>
                <p>1309 Coffeen Avenue STE 1200<br>Sheridan Wyoming 82801</p>
                <p>Phone: <a href="tel:+12708181816">(270) 818-1816</a></p>
                <p>Email: <a href="mailto:info@turnclickstoclients.com">info@turnclickstoclients.com</a></p>
            </div>
            <div class="footer-column footer-quick-links">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../about.html">About Us</a></li>
                    <li><a href="../index.html#ideal-clients">Clients We Serve</a></li>
                    <li><a href="../index.html#core-offer">Our Offer</a></li>
                    <li><a href="../index.html#guarantee">Guarantee</a></li>
                    <li><a href="../contact.html">Contact Us</a></li>
                    <li><a href="../privacy-policy.html">Privacy Policy</a></li>
                    <li><a href="../terms-of-service.html">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-column footer-niches">
                <h3>Niche Expertise</h3>
                <ul>
                    <li><a href="child-care-centers.html">Child Care Centers</a></li>
                    <li><a href="cosmetic-dentists.html">Cosmetic Dentists</a></li>
                    <li><a href="pmu-artists.html">PMU Artists</a></li>
                    <li><a href="non-surgical-body-contouring.html">Body Contouring</a></li>
                    <li><a href="weight-loss-clinics.html">Weight Loss Clinics</a></li>
                    <li><a href="high-end-chiropractors.html">Chiropractors</a></li>
                    <li><a href="sleep-apnea-snoring-clinics.html">Sleep Apnea Clinics</a></li>
                    <li><a href="hearing-aid-audiology-clinics.html">Audiology Clinics</a></li>
                    <li><a href="dme-clinics.html">DME Clinics</a></li>
                </ul>
            </div>
            <div class="footer-column footer-social">
                <h3>Connect With Us</h3>
                <div class="social-icons">
                    <a href="https://www.linkedin.com/in/aaron-p-813553112/" aria-label="LinkedIn" target="_blank">LinkedIn</a>
                </div>
                <p>Stay updated with our latest insights and offers.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; <script>document.write(new Date().getFullYear())</script> TurnClicksToClients.com. All rights reserved. | One Client Per City, Per Niche.</p>
        </div>
    </footer>

    <!-- Chat Button and Modal -->
    <div id="chat-widget-button">
        <span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span> Chat
    </div>
    <div id="chat-modal" class="modal-hidden">
        <div class="chat-modal-content">
            <div class="chat-modal-header">
                <h2>Start a Conversation</h2>
                <button id="chat-modal-close" class="chat-close-button">&times;</button>
            </div>
            <div class="chat-modal-body">
                <p>
                    <strong>Connect with Our Team Live!</strong><br>
                    Mon-Fri, 10am - 5pm EST: Expect a reply within the hour.<br>
                    After hours & weekends: We'll get back to you first thing next business morning.<br><br>
                    Let us know how we can help your business grow! Please fill out the form below.
                </p>
                <form id="chat-contact-form">
                    <div class="form-group">
                        <label for="chat-industry">Your Industry:</label>
                        <select id="chat-industry" name="industry" required>
                            <option value="" disabled selected>Select your industry...</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chat-name">Full Name:</label>
                        <input type="text" id="chat-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="chat-businessName">Business Name:</label>
                        <input type="text" id="chat-businessName" name="businessName" required>
                    </div>
                    <div class="form-group">
                        <label for="chat-email">Email Address:</label>
                        <input type="email" id="chat-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="chat-phone">Phone Number:</label>
                        <input type="tel" id="chat-phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="chat-message">How can we help you?</label>
                        <textarea id="chat-message" name="message" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="cta-button secondary chat-submit-button">Send Message</button>
                </form>
                <div id="chat-success-message" style="display: none; text-align: center; padding: 20px;">
                    <h3>Thank You!</h3>
                    <p>Our team has been alerted and will get back to you as soon as possible.</p>
                    <p>You can now close this window.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        const SUPABASE_URL = 'https://eumhqssfvkyuepyrtlqj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bWhxc3Nmdmt5dWVweXJ0bHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NjE0MDEsImV4cCI6MjA2MjEzNzQwMX0.w-UzQq1G6GIinBdlIcW34KBSoeaAK-knNs4AvL8ct64';
        let supabaseClient = null;

        // Initialize Supabase client when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DME Quiz: DOMContentLoaded event fired");
            console.log("DME Quiz: Checking for Supabase library...");
            console.log("DME Quiz: typeof supabase =", typeof supabase);
            console.log("DME Quiz: supabase object available =", typeof supabase !== 'undefined');
            console.log("DME Quiz: createClient method available =", typeof supabase !== 'undefined' && typeof supabase.createClient === 'function');

            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Supabase client initialized for DME Clinics Quiz:", supabaseClient);

                    // Test the connection
                    supabaseClient.auth.getSession().then(response => {
                        console.log("DME Quiz: Supabase connection test - getSession response:", response);
                    }).catch(error => {
                        console.error("DME Quiz: Supabase connection test failed:", error);
                    });

                    // Test table access - try to select from redirections table
                    testSupabaseTableAccess();
                } else {
                    console.error("Supabase client library (supabase.js) is not loaded for DME Clinics Quiz.");
                }
            } catch (e) {
                console.error("Error initializing Supabase client for DME Clinics Quiz:", e.message);
                console.error("Error stack:", e.stack);
            }
        });

        // Function to test Supabase table access
        async function testSupabaseTableAccess() {
            console.log("DME Quiz: Testing Supabase table access...");
            if (!supabaseClient) {
                console.error("DME Quiz: Cannot test table access - supabaseClient not initialized");
                return;
            }

            try {
                // Test SELECT on redirections table
                console.log("DME Quiz: Testing SELECT on tctc_quiz_redirections table...");
                const { data: selectData, error: selectError } = await supabaseClient
                    .from('tctc_quiz_redirections')
                    .select('*')
                    .limit(1);

                if (selectError) {
                    console.error("DME Quiz: SELECT test failed:", selectError);
                } else {
                    console.log("DME Quiz: SELECT test successful:", selectData);
                }

                // Test INSERT to redirections table
                console.log("DME Quiz: Testing INSERT to tctc_quiz_redirections table...");
                const testData = {
                    user_first_name: "Test",
                    user_last_name: "Init",
                    user_business_name: "Table Test",
                    quiz_score: 0,
                    outcome_bucket: "test",
                    awareness_variant: "test",
                    redirect_url: "test",
                    source: "test",
                    redirected_at: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await supabaseClient
                    .from('tctc_quiz_redirections')
                    .insert([testData])
                    .select();

                if (insertError) {
                    console.error("DME Quiz: INSERT test failed:", insertError);
                    console.error("DME Quiz: Error code:", insertError.code);
                    console.error("DME Quiz: Error message:", insertError.message);
                    console.error("DME Quiz: Error details:", insertError.details);
                } else {
                    console.log("DME Quiz: INSERT test successful:", insertData);
                }
            } catch (e) {
                console.error("DME Quiz: Exception during table access test:", e);
            }
        }

        let currentQuestionIndex = 0;
        let userAnswers = []; // DME: Array of scores
        let quizStarted = false;
        const sourceParam = new URLSearchParams(window.location.search).get('source');

        // DME Quiz Questions - REINSTATED
        const quizQuestions = [
            {
                question: "How effectively does your DME business currently generate new patient referrals from physicians, hospitals, or other healthcare providers?",
                answers: [
                    { text: "Referral flow is inconsistent and heavily reliant on a few key sources.", score: 1 },
                    { text: "We receive some referrals, but lack a proactive system for cultivating and expanding our referral network.", score: 2 },
                    { text: "We have good relationships with several referrers, but could improve our outreach and communication to generate more consistent volume.", score: 3 },
                    { text: "We have a strong, diversified referral network and a systematic approach to nurturing these relationships, ensuring a steady flow of qualified patients.", score: 4 }
                ]
            },
            {
                question: "How streamlined and efficient is your intake, documentation, and insurance verification process for new DME patients?",
                answers: [
                    { text: "Often manual and time-consuming, leading to delays, errors, or claim denials.", score: 1 },
                    { text: "Partially digitized, but still involves significant paperwork and potential for bottlenecks.", score: 2 },
                    { text: "Mostly efficient, but there are still areas where we could improve automation and reduce administrative burden.", score: 3 },
                    { text: "Highly streamlined and automated, minimizing errors, speeding up approvals, and improving cash flow.", score: 4 }
                ]
            },
            {
                question: "How would you rate your DME business\'s patient education and support for equipment setup, usage, and troubleshooting?",
                answers: [
                    { text: "Basic; patients sometimes struggle with their equipment or have unresolved questions.", score: 1 },
                    { text: "Adequate; we provide instructions, but follow-up and proactive support could be better.", score: 2 },
                    { text: "Good; patients generally feel supported, but we could enhance our educational resources or remote assistance capabilities.", score: 3 },
                    { text: "Excellent; we offer comprehensive education, proactive support, and readily accessible assistance, leading to high patient satisfaction and compliance.", score: 4 }
                ]
            },
            {
                question: "How effectively does your DME business manage inventory, resupply, and patient follow-up for ongoing equipment needs (e.g., CPAP supplies, diabetic testing strips)?",
                answers: [
                    { text: "Reactive and often inefficient; we struggle with stockouts, late resupplies, or missed follow-ups.", score: 1 },
                    { text: "We manage, but inventory control and proactive resupply are ongoing challenges.", score: 2 },
                    { text: "Generally good, but we could improve our systems for forecasting, automation, and personalized patient communication for resupply.", score: 3 },
                    { text: "Highly efficient and patient-centric, with automated systems ensuring timely resupply and proactive patient engagement.", score: 4 }
                ]
            },
            {
                question: "What is the primary growth objective for your DME business in the next 1-3 years?",
                answers: [
                    { text: "To maintain current patient base and revenue streams.", score: 1 },
                    { text: "To moderately increase patient volume and expand into closely related product lines.", score: 2 },
                    { text: "To significantly grow our market share, improve profitability through operational efficiencies, and strengthen referral partnerships.", score: 3 },
                    { text: "To become a leading regional DME provider, potentially by diversifying into new specialized equipment categories, adopting advanced technologies, or expanding geographically.", score: 4 }
                ]
            },
            // New "Growth-Stifler" question
            {
                question: "Every business has them: those 'invisible chains' of costly overhead or tedious manual processes that secretly stifle growth and sanity. What ONE such chain, if broken, would provide the most immediate and profound boost to your business\'s efficiency and your personal peace of mind? *",
                type: "textarea",
                id: "growth_stifler_response_quiz"
            }
        ];

        const quizArea = document.getElementById('quiz-area');
        const quizBenefitsIntro = document.getElementById('quiz-benefits-intro');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizQuestionDiv = document.getElementById('quiz-question');
        const quizAnswersDiv = document.getElementById('quiz-answers');
        const quizNavigationDiv = document.querySelector('.quiz-navigation');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const leadCaptureForm = document.getElementById('lead-capture-form');
        const quizResultDiv = document.getElementById('quiz-result');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');

        function startQuiz() {
            quizStarted = true;
            quizBenefitsIntro.style.display = 'none';
            startQuizBtn.style.display = 'none';
            quizQuestionDiv.style.display = 'block';
            quizAnswersDiv.style.display = 'block';
            quizNavigationDiv.style.display = 'none';
            nextQuestionBtn.style.display = 'none';
            progressBarContainer.style.display = 'block';
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex < quizQuestions.length) {
                const questionData = quizQuestions[currentQuestionIndex];
                const h2 = quizQuestionDiv.querySelector('h2');
                h2.textContent = questionData.question;

                const oldInstruction = quizQuestionDiv.querySelector('p.instruction-text');
                if (oldInstruction) {
                    oldInstruction.remove();
                }

                const answersUl = quizAnswersDiv.querySelector('ul');
                answersUl.innerHTML = '';

                if (questionData.type === "textarea") {
                    const instructionP = document.createElement('p');
                    instructionP.textContent = "Please type your answer below:";
                    instructionP.className = 'instruction-text';
                    instructionP.style.fontSize = '0.9em';
                    instructionP.style.color = '#666';
                    instructionP.style.marginTop = '5px';
                    h2.after(instructionP);

                    // Remove any existing "why we're asking" explanation
                    const existingWhyAskingP = quizQuestionDiv.querySelector('.why-asking-explanation');
                    if (existingWhyAskingP) {
                        existingWhyAskingP.remove();
                    }

                    // Add "why we're asking" explanation
                    const whyAskingP = document.createElement('p');
                    whyAskingP.className = 'why-asking-explanation'; // Add a class for easy identification
                    whyAskingP.innerHTML = "<strong>Why we're asking:</strong> We want to understand your specific challenges so we can tailor our recommendations to address your most pressing needs and help you achieve faster results with your DME business.";
                    whyAskingP.style.fontSize = '0.85em';
                    whyAskingP.style.color = '#555';
                    whyAskingP.style.backgroundColor = '#f8f9fa';
                    whyAskingP.style.padding = '10px';
                    whyAskingP.style.borderRadius = '4px';
                    whyAskingP.style.marginTop = '10px';
                    whyAskingP.style.marginBottom = '15px';
                    whyAskingP.style.borderLeft = '3px solid #007bff';
                    instructionP.after(whyAskingP);

                    const li = document.createElement('li');
                    const textarea = document.createElement('textarea');
                    textarea.id = questionData.id;
                    textarea.name = questionData.id;
                    textarea.rows = 4;
                    textarea.style.width = '100%';
                    textarea.style.padding = '10px';
                    textarea.style.borderColor = '#ccc';
                    textarea.style.borderRadius = '4px';
                    textarea.required = true;
                    li.appendChild(textarea);
                    answersUl.appendChild(li);

                    nextQuestionBtn.textContent = "Next";
                    nextQuestionBtn.onclick = handleTextareaAnswer;
                    quizNavigationDiv.style.display = 'block';
                    nextQuestionBtn.style.display = 'inline-block';

                } else {
                    const instructionP = document.createElement('p');
                    instructionP.textContent = "Select your answer below:";
                    instructionP.className = 'instruction-text';
                    instructionP.style.fontSize = '0.9em';
                    instructionP.style.color = '#666';
                    instructionP.style.marginTop = '5px';
                    h2.after(instructionP);

                    // Remove any existing "why we're asking" explanation
                    const existingWhyAskingP = quizQuestionDiv.querySelector('.why-asking-explanation');
                    if (existingWhyAskingP) {
                        existingWhyAskingP.remove();
                    }

                    // Add "why we're asking" explanation with specific reasons based on question index
                    const whyAskingP = document.createElement('p');
                    whyAskingP.className = 'why-asking-explanation'; // Add a class for easy identification
                    let whyText = "";

                    // Customize the explanation based on the question
                    switch(currentQuestionIndex) {
                        case 0:
                            whyText = "We're asking because your referral network directly impacts your DME business growth. Your answer helps us identify if strengthening referral relationships should be a priority in your growth plan.";
                            break;
                        case 1:
                            whyText = "We're asking because efficient intake and verification processes significantly affect cash flow and patient satisfaction. Your answer helps us determine if operational improvements could increase your profitability.";
                            break;
                        case 2:
                            whyText = "We're asking because patient education and support directly impact compliance, satisfaction, and referrals. Your answer helps us assess if enhancing your support systems could be a growth lever for your business.";
                            break;
                        case 3:
                            whyText = "We're asking because inventory management and resupply processes are often hidden profit centers in DME businesses. Your answer helps us identify if optimizing these systems could boost your revenue.";
                            break;
                        case 4:
                            whyText = "We're asking because your growth objectives influence which strategies will be most effective for your DME business. Your answer helps us tailor our recommendations to your specific ambitions.";
                            break;
                        default:
                            whyText = "We're asking to better understand your DME business and provide more tailored recommendations for growth.";
                    }

                    whyAskingP.innerHTML = "<strong>Why we're asking:</strong> " + whyText;
                    whyAskingP.style.fontSize = '0.85em';
                    whyAskingP.style.color = '#555';
                    whyAskingP.style.backgroundColor = '#f8f9fa';
                    whyAskingP.style.padding = '10px';
                    whyAskingP.style.borderRadius = '4px';
                    whyAskingP.style.marginTop = '10px';
                    whyAskingP.style.marginBottom = '15px';
                    whyAskingP.style.borderLeft = '3px solid #007bff';
                    instructionP.after(whyAskingP);

                    questionData.answers.forEach((answer) => {
                        const li = document.createElement('li');
                        const button = document.createElement('button');
                        button.classList.add('answer-btn');
                        button.textContent = answer.text;
                        button.onclick = () => selectAnswer(answer.score, button);
                        li.appendChild(button);
                        answersUl.appendChild(li);
                    });
                    quizNavigationDiv.style.display = 'none';
                    nextQuestionBtn.style.display = 'none';
                }
                updateProgressBar();
            } else {
                showLeadCaptureForm();
            }
        }

        function handleTextareaAnswer() {
            const questionData = quizQuestions[currentQuestionIndex];
            const textarea = document.getElementById(questionData.id);
            if (textarea && textarea.value.trim() !== "") {
                userAnswers[currentQuestionIndex] = textarea.value.trim();
                nextQuestion();
            } else {
                alert("Please provide an answer to this question.");
            }
        }

        function selectAnswer(score, selectedButton) {
            const buttons = quizAnswersDiv.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            userAnswers[currentQuestionIndex] = score;
            setTimeout(nextQuestion, 500);
        }

        function nextQuestion() {
            const currentQuestionData = quizQuestions[currentQuestionIndex];
            if (currentQuestionData.type !== "textarea" && userAnswers[currentQuestionIndex] === undefined) {
                alert("Please select an answer before proceeding.");
                return;
            }

            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuestion();
            } else {
                showLeadCaptureForm();
            }
        }

        function updateProgressBar() {
            const progress = (currentQuestionIndex / quizQuestions.length) * 100;
            progressBar.style.width = progress + '%';
        }

        function showLeadCaptureForm() {
            quizQuestionDiv.style.display = 'none';
            quizAnswersDiv.style.display = 'none';
            quizNavigationDiv.style.display = 'none';
            progressBarContainer.style.display = 'none';
            leadCaptureForm.style.display = 'block';
            quizResultDiv.style.display = 'none';
        }

        // DME Specific Outcome Logic - REINSTATED
        function determineOutcome(score) {
            if (score >= 5 && score <= 8) return "referrals";
            if (score >= 9 && score <= 12) return "operations";
            if (score >= 13 && score <= 20) return "growth";
            return "general";
        }

        async function handleLeadSubmit() {
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const businessName = document.getElementById('business-name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            let growth_stifler_response = "";
            const growthStiflerQuestionIndex = quizQuestions.findIndex(q => q.type === "textarea");
            if (growthStiflerQuestionIndex !== -1 && userAnswers[growthStiflerQuestionIndex]) {
                growth_stifler_response = userAnswers[growthStiflerQuestionIndex];
            }

            if (!firstName || !lastName || !businessName || !email || !phone) {
                alert("Please fill in all required fields in the form.");
                return;
            }

            if (growthStiflerQuestionIndex !== -1 && !userAnswers[growthStiflerQuestionIndex]) {
                 alert("Please ensure all quiz questions, including the open-ended one, are answered.");
                 return;
            }

            leadCaptureForm.style.display = 'none';
            quizResultDiv.innerHTML = '<h3>Analyzing Your DME Business Growth Potential...</h3><p>Just a moment while we tailor your strategic assessment.</p>';
            quizResultDiv.style.display = 'block';

            let totalScore = userAnswers.reduce((acc, score) => acc + (typeof score === 'number' ? score : 0), 0);
            console.log("DME Total score calculated:", totalScore);

            // DME: Construct detailedQuizAnswers - REINSTATED
            const detailedQuizAnswers = userAnswers.map((answerData, index) => {
                const questionData = quizQuestions[index];
                if (questionData.type === "textarea") {
                    return {
                        question: questionData.question,
                        answer: answerData,
                        score: null
                    };
                }
                const selectedAnswerObject = questionData.answers.find(ans => ans.score === answerData);
                return {
                    question: questionData.question,
                    answer: selectedAnswerObject ? selectedAnswerObject.text : "N/A - Score not found",
                    score: answerData
                };
            });
            console.log("DME Detailed quiz answers constructed:", detailedQuizAnswers);

            const primaryOutcomeHint = determineOutcome(totalScore); // DME specific
            console.log("DME Primary outcome hint:", primaryOutcomeHint);

            const submissionData = {
                first_name: firstName,
                last_name: lastName,
                business_name: businessName,
                email: email,
                phone: phone,
                growth_stifler_response: growth_stifler_response,
                niche: 'DME Clinics', // DME specific
                quiz_answers: detailedQuizAnswers,
                total_score: totalScore,
                primary_outcome_hint: primaryOutcomeHint,
                source: sourceParam || 'organic',
                submitted_at: new Date().toISOString(),
            };
            console.log("DME Submission data prepared:", submissionData);

            let dbError = false;
            let supabaseInsertError = null;

            if (supabaseClient) {
                console.log("DME: Attempting Supabase insert...");
                try {
                    const { data, error } = await supabaseClient
                        .from('tctc_quiz_submission')
                        .insert([submissionData])
                        .select(); // Added select to see if it returns the inserted data or error more clearly

                    if (error) {
                        console.error('DME: Error inserting data into Supabase:', error);
                        supabaseInsertError = error;
                        dbError = true;
                    } else {
                        console.log('DME: Data successfully inserted into Supabase:', data);
                        // INVOKE THE EDGE FUNCTION TO SEND TO SLACK
                        try {
                            console.log('DME: Attempting to invoke quiz-slack-notify Edge Function with data:', submissionData);
                            const { data: funcData, error: funcError } = await supabaseClient.functions.invoke('quiz-slack-notify', {
                                body: submissionData // Pass the same submissionData
                            });

                            if (funcError) {
                                console.error('DME: Error invoking quiz-slack-notify Edge Function:', funcError);
                            } else {
                                console.log('DME: quiz-slack-notify Edge Function invoked successfully:', funcData);
                            }
                        } catch (invokeCatchError) {
                            console.error('DME: Exception caught when trying to invoke Edge Function:', invokeCatchError);
                        }
                    }
                } catch (e) {
                    console.error('DME: Exception during Supabase insert:', e);
                    supabaseInsertError = e;
                    dbError = true;
                }
                console.log("DME: Supabase insert attempt finished. dbError:", dbError);
            } else {
                console.warn("DME: Supabase client not initialized. Skipping database insert.");
                // dbError is already false by default, or set by a failed Supabase attempt if client was available.
                // If client is not initialized, we might want to set dbError to true and provide a specific message.
                if (!supabaseInsertError) { // Only set if no other Supabase error occurred
                    supabaseInsertError = { message: 'Supabase client not initialized' };
                    dbError = true; // Ensure redirection logic knows there was an issue.
                }
            }

            // await sendQuizSubmissionToSlack(submissionData); // Removed old direct Slack call

            // DME Specific Redirection Logic - ADJUSTED
            determineOutcomeAndRedirect(firstName, lastName, businessName, totalScore, supabaseClient, dbError, sourceParam, supabaseInsertError);
        }

        async function determineOutcomeAndRedirect(firstName, lastName, businessName, totalScore, supabaseClient, dbError, sourceParam, supabaseInsertError) {
            const encodedFirstName = encodeURIComponent(firstName);
            const encodedLastName = encodeURIComponent(lastName);
            const encodedBusinessName = encodeURIComponent(businessName);
            const baseParams = `firstName=${encodedFirstName}&lastName=${encodedLastName}&businessName=${encodedBusinessName}&score=${totalScore}`;
            const sourceAndDbErrorParams = `${sourceParam ? `&source=${encodeURIComponent(sourceParam)}` : ''}&track_source=quiz${dbError ? `&dbError=${encodeURIComponent(supabaseInsertError?.message || 'Unknown error')}` : ''}`;

            // Determine the outcome bucket based on the score
            const outcomeCategory = determineOutcome(totalScore);
            const scoreBucket = outcomeCategory; // referrals, operations, or growth

            // Determine which awareness variant to show based on score distribution
            let awarenessVariant;
            if (scoreBucket === "referrals") {
                // Lower scores within this bucket get problem variant, higher get solution variant, etc.
                if (totalScore <= 6) {
                    awarenessVariant = "b-problem"; // Problem Aware
                } else if (totalScore <= 7) {
                    awarenessVariant = "a-solution"; // Solution Aware
                } else {
                    awarenessVariant = "c-most-aware"; // Most Aware
                }
            }
            else if (scoreBucket === "operations") {
                if (totalScore <= 10) {
                    awarenessVariant = "b-problem"; // Problem Aware
                } else if (totalScore <= 11) {
                    awarenessVariant = "a-solution"; // Solution Aware
                } else {
                    awarenessVariant = "c-most-aware"; // Most Aware
                }
            }
            else { // growth
                if (totalScore <= 16) {
                    awarenessVariant = "b-problem"; // Problem Aware
                } else if (totalScore <= 18) {
                    awarenessVariant = "a-solution"; // Solution Aware
                } else {
                    awarenessVariant = "c-most-aware"; // Most Aware
                }
            }

            // Construct the new URL with bucket and variant
            const url = `../quiz-applications/dme-clinics/${scoreBucket}/${scoreBucket}-variant-${awarenessVariant}.html${baseParams ? '?' + baseParams : '?'}${sourceAndDbErrorParams}&bucket=${scoreBucket}&variant=${awarenessVariant}`;

            // Track the redirection in Supabase before redirecting
            if (supabaseClient) {
                try {
                    console.log("DME: About to insert redirection tracking data:", {
                        user_first_name: firstName,
                        user_last_name: lastName,
                        user_business_name: businessName,
                        quiz_score: totalScore,
                        outcome_bucket: scoreBucket,
                        awareness_variant: awarenessVariant,
                        redirect_url: url,
                        source: sourceParam || 'organic',
                        redirected_at: new Date().toISOString()
                    });

                    const { data, error } = await supabaseClient
                        .from('tctc_quiz_redirections')
                        .insert([{
                            user_first_name: firstName,
                            user_last_name: lastName,
                            user_business_name: businessName,
                            quiz_score: totalScore,
                            outcome_bucket: scoreBucket,
                            awareness_variant: awarenessVariant,
                            redirect_url: url,
                            source: sourceParam || 'organic',
                            redirected_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) {
                        console.error('Error tracking DME clinics redirection:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Error details:', error.details);
                        console.error('Error hint:', error.hint);
                    } else {
                        console.log('DME clinics redirection tracking successful:', data);
                    }
                } catch (e) {
                    console.error('Exception during DME redirection tracking:', e);
                    console.error('Exception name:', e.name);
                    console.error('Exception message:', e.message);
                    console.error('Exception stack:', e.stack);
                }
            } else {
                console.error('DME: supabaseClient is not initialized for redirection tracking');
                console.log('DME: Current supabaseClient value:', supabaseClient);
            }

            // Redirect regardless of tracking success
            console.log("DME: Redirecting to:", url);
            window.location.href = url;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Any DOM-dependent setup that needs to run after HTML is parsed
            // For example, attaching event listeners if not done inline.
            // startQuizBtn is handled by onclick, so likely nothing needed here for now.
             if (!supabaseClient) { // Double check here as well
                console.warn("DME Quiz: Supabase client was not available on DOMContentLoaded. Check script loading order and initialization.");
            }
        });
    </script>
    <script src="../script.js"></script>
    <script src="../tracking.js"></script>
    <script src="../tracking-enhanced.js"></script>
    <script src="../hamburger_fix.js"></script>
</body>
</html>
