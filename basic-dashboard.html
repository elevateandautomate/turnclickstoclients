<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Basic Dashboard</h1>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Total Visitors</h3>
            <div class="metric-value" id="total-visitors">Loading...</div>
            <div class="metric-label">Unique visitors</div>
        </div>

        <div class="metric-card">
            <h3>Quiz Starts</h3>
            <div class="metric-value" id="quiz-starts">Loading...</div>
            <div class="metric-label">Unique users</div>
        </div>

        <div class="metric-card">
            <h3>Quiz Completions</h3>
            <div class="metric-value" id="quiz-completions">Loading...</div>
            <div class="metric-label">Unique users</div>
        </div>

        <div class="metric-card">
            <h3>Quiz Submissions</h3>
            <div class="metric-value" id="quiz-submissions">Loading...</div>
            <div class="metric-label">Total submissions</div>
        </div>
    </div>
    
    <h2>Recent Quiz Submissions</h2>
    <table class="data-table" id="submissions-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Business</th>
                <th>Niche</th>
                <th>Score</th>
                <th>Outcome</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="6">Loading submissions...</td>
            </tr>
        </tbody>
    </table>
    
    <script>
        // Supabase API details
        const SUPABASE_URL = 'https://eumhqssfvkyuepyrtlqj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bWhxc3Nmdmt5dWVweXJ0bHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NjE0MDEsImV4cCI6MjA2MjEzNzQwMX0.w-UzQq1G6GIinBdlIcW34KBSoeaAK-knNs4AvL8ct64';
        
        // Function to fetch data from Supabase
        async function fetchFromSupabase(table, query = '') {
            try {
                console.log(`Fetching from ${table}${query ? ' with query ' + query : ''}...`);
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`Fetched ${data.length} items from ${table}`);
                
                return data;
            } catch (error) {
                console.error(`Error fetching from ${table}: ${error.message}`);
                return [];
            }
        }
        
        // Count unique users in data
        function countUniqueUsers(data) {
            const uniqueUsers = new Set();
            data.forEach(item => {
                if (item.user_id) {
                    uniqueUsers.add(item.user_id);
                }
            });
            return uniqueUsers.size;
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Fetch page views
                const pageViews = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.page_view');
                document.getElementById('total-visitors').textContent = countUniqueUsers(pageViews);
                
                // Fetch quiz starts
                const quizStarts = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.quiz_started');
                document.getElementById('quiz-starts').textContent = countUniqueUsers(quizStarts);
                
                // Fetch quiz completions
                const quizCompletions = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.quiz_completed');
                document.getElementById('quiz-completions').textContent = countUniqueUsers(quizCompletions);
                
                // Fetch quiz submissions
                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', '?select=*&order=created_at.desc');
                document.getElementById('quiz-submissions').textContent = quizSubmissions.length;
                
                // Populate submissions table
                const tableBody = document.querySelector('#submissions-table tbody');
                if (quizSubmissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">No submissions found</td></tr>';
                } else {
                    tableBody.innerHTML = quizSubmissions.slice(0, 10).map(submission => `
                        <tr>
                            <td>${submission.first_name} ${submission.last_name}</td>
                            <td>${submission.business_name || 'N/A'}</td>
                            <td>${submission.niche || 'N/A'}</td>
                            <td>${submission.total_score || 'N/A'}</td>
                            <td>${submission.primary_outcome_hint || 'N/A'}</td>
                            <td>${formatDate(submission.created_at)}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('total-visitors').textContent = 'Error';
                document.getElementById('quiz-starts').textContent = 'Error';
                document.getElementById('quiz-completions').textContent = 'Error';
                document.getElementById('quiz-submissions').textContent = 'Error';
            }
        }
        
        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
