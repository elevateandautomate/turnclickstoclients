<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabbed Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2563eb;
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
            margin: 0;
            padding: 0;
        }
        nav a {
            text-decoration: none;
            color: #6b7280;
            font-weight: 500;
            padding: 0.5rem 0;
            position: relative;
            transition: color 0.2s;
        }
        nav a:hover {
            color: #2563eb;
        }
        nav a.active {
            color: #2563eb;
        }
        nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #2563eb;
        }
        main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .dashboard-section {
            display: none;
        }
        .dashboard-section.active {
            display: block;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .placeholder-message {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">TurnClicksToClients Dashboard</div>
        <nav>
            <ul>
                <li><a href="#overview" class="active">Overview</a></li>
                <li><a href="#user-flow">User Flow</a></li>
                <li><a href="#quiz-analytics">Quiz Analytics</a></li>
                <li><a href="#conversion">Conversion</a></li>
                <li><a href="#users">Users</a></li>
                <li><a href="#offers">Offers & Tests</a></li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 10px;">
            <div>
                <label for="date-range" style="margin-right: 5px;">Date Range:</label>
                <select id="date-range" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="7days" selected>Last 7 Days</option>
                    <option value="30days">Last 30 Days</option>
                    <option value="90days">Last 90 Days</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div>
                <label for="niche-filter" style="margin-right: 5px;">Niche:</label>
                <select id="niche-filter" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" selected>All Niches</option>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            <button id="refresh-btn" style="padding: 5px 10px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Refresh Data
            </button>
        </div>
    </header>

    <main>
        <section id="overview" class="dashboard-section active">
            <h1>Dashboard Overview</h1>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Visitors</h3>
                    <div class="metric-value" id="total-visitors">Loading...</div>
                    <div class="metric-label">Unique visitors</div>
                </div>

                <div class="metric-card">
                    <h3>Quiz Starts</h3>
                    <div class="metric-value" id="quiz-starts">Loading...</div>
                    <div class="metric-label">Unique users</div>
                </div>

                <div class="metric-card">
                    <h3>Quiz Completions</h3>
                    <div class="metric-value" id="quiz-completions">Loading...</div>
                    <div class="metric-label">Unique users</div>
                </div>

                <div class="metric-card">
                    <h3>Quiz Submissions</h3>
                    <div class="metric-value" id="quiz-submissions">Loading...</div>
                    <div class="metric-label">Total submissions</div>
                </div>

                <div class="metric-card">
                    <h3>Application Submissions</h3>
                    <div class="metric-value" id="application-submissions">Loading...</div>
                    <div class="metric-label">Total applications</div>
                </div>
            </div>

            <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                    <h3>Traffic by Source</h3>
                    <div style="height: 300px;">
                        <canvas id="traffic-source-chart"></canvas>
                    </div>
                </div>

                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                    <h3>Conversions by Niche</h3>
                    <div style="height: 300px;">
                        <canvas id="niche-conversion-chart"></canvas>
                    </div>
                </div>
            </div>

            <h2>Recent Quiz Submissions</h2>
            <table class="data-table" id="submissions-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Business</th>
                        <th>Niche</th>
                        <th>Score</th>
                        <th>Outcome</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6">Loading submissions...</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="user-flow" class="dashboard-section">
            <h1>User Flow Analysis</h1>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Funnel Conversion</h3>
                    <div style="height: 300px;">
                        <canvas id="funnel-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>User Journey Stats</h3>
                    <div id="journey-stats" style="padding: 20px;">
                        <p>Loading journey statistics...</p>
                    </div>
                </div>
            </div>

            <h2>User Journeys</h2>
            <div id="user-journeys" style="margin-top: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <p>Loading user journeys...</p>
            </div>
        </section>

        <section id="quiz-analytics" class="dashboard-section">
            <h1>Quiz Analytics</h1>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Quiz Submissions by Niche</h3>
                    <div style="height: 300px;">
                        <canvas id="quiz-niche-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Quiz Score Distribution</h3>
                    <div style="height: 300px;">
                        <canvas id="quiz-score-chart"></canvas>
                    </div>
                </div>
            </div>

            <h2>Quiz Question Analysis</h2>
            <div id="question-analysis" style="margin-top: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <p>Loading question analysis...</p>
            </div>
        </section>

        <section id="conversion" class="dashboard-section">
            <h1>Application Submissions</h1>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Applications by Niche</h3>
                    <div style="height: 300px;">
                        <canvas id="applications-niche-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Applications Over Time</h3>
                    <div style="height: 300px;">
                        <canvas id="applications-time-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Conversion Rates</h3>
                    <div style="height: 300px;">
                        <canvas id="conversion-rate-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Applications by Source</h3>
                    <div style="height: 300px;">
                        <canvas id="applications-source-chart"></canvas>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <h3>Conversion Funnel</h3>
                <div style="display: flex; justify-content: space-between; margin-top: 20px; text-align: center;">
                    <div style="flex: 1; padding: 15px; background-color: #f0f9ff; border-radius: 8px; margin-right: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="funnel-visitors">0</div>
                        <div>Page Views</div>
                    </div>
                    <div style="margin-top: 25px;">→</div>
                    <div style="flex: 1; padding: 15px; background-color: #f0f9ff; border-radius: 8px; margin-right: 10px; margin-left: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="funnel-quiz-starts">0</div>
                        <div>Quiz Starts</div>
                        <div style="font-size: 12px; color: #666;" id="funnel-quiz-starts-rate">0%</div>
                    </div>
                    <div style="margin-top: 25px;">→</div>
                    <div style="flex: 1; padding: 15px; background-color: #f0f9ff; border-radius: 8px; margin-right: 10px; margin-left: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="funnel-quiz-completions">0</div>
                        <div>Quiz Completions</div>
                        <div style="font-size: 12px; color: #666;" id="funnel-quiz-completions-rate">0%</div>
                    </div>
                    <div style="margin-top: 25px;">→</div>
                    <div style="flex: 1; padding: 15px; background-color: #f0f9ff; border-radius: 8px; margin-right: 10px; margin-left: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="funnel-applications">0</div>
                        <div>Applications</div>
                        <div style="font-size: 12px; color: #666;" id="funnel-applications-rate">0%</div>
                    </div>
                </div>
            </div>

            <h2>Recent Application Submissions</h2>
            <table class="data-table" id="applications-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>User ID</th>
                        <th>Niche</th>
                        <th>Traffic Source</th>
                        <th>Page URL</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7">Loading applications...</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="users" class="dashboard-section">
            <h1>User Details</h1>

            <div style="margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label for="user-search" style="display: block; margin-bottom: 5px; font-weight: bold;">Search User:</label>
                        <input type="text" id="user-search" placeholder="Enter user ID or email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label for="user-filter" style="display: block; margin-bottom: 5px; font-weight: bold;">Filter by Activity:</label>
                        <select id="user-filter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="all">All Users</option>
                            <option value="quiz_completed">Completed Quiz</option>
                            <option value="application">Submitted Application</option>
                            <option value="high_value">High Value (Multiple Sessions)</option>
                        </select>
                    </div>
                    <div style="align-self: flex-end;">
                        <button id="user-search-btn" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                    </div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Users by Niche</h3>
                    <div style="height: 300px;">
                        <canvas id="users-niche-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Users by Source</h3>
                    <div style="height: 300px;">
                        <canvas id="users-source-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>User Engagement</h3>
                    <div style="height: 300px;">
                        <canvas id="user-engagement-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>User Retention</h3>
                    <div style="height: 300px;">
                        <canvas id="user-retention-chart"></canvas>
                    </div>
                </div>
            </div>

            <h2>User List</h2>
            <table class="data-table" id="users-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                        <th>Sessions</th>
                        <th>Quiz Status</th>
                        <th>Application Status</th>
                        <th>Traffic Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8">Loading users...</td>
                    </tr>
                </tbody>
            </table>

            <div id="user-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; width: 80%; max-width: 800px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <button id="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                    <h2>User Journey Details</h2>
                    <div id="user-journey-details" style="margin-top: 20px;">
                        <p>Loading user details...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="offers" class="dashboard-section">
            <h1>Offers & Split Tests</h1>

            <div style="margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Active Split Tests</h2>
                    <button id="create-test-btn" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Create New Test</button>
                </div>

                <table class="data-table" id="split-tests-table">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>Niche</th>
                            <th>Variants</th>
                            <th>Impressions</th>
                            <th>Conversions</th>
                            <th>Conv. Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9">No active split tests</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Test Performance</h3>
                    <div style="height: 300px;">
                        <canvas id="test-performance-chart"></canvas>
                    </div>
                </div>

                <div class="metric-card">
                    <h3>Conversion by Offer</h3>
                    <div style="height: 300px;">
                        <canvas id="offer-conversion-chart"></canvas>
                    </div>
                </div>
            </div>

            <h2>Offer Library</h2>
            <div style="margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <input type="text" id="offer-search" placeholder="Search offers..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 250px;">
                        <select id="offer-filter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-left: 10px;">
                            <option value="all">All Niches</option>
                            <option value="health-coach">Health Coach</option>
                            <option value="life-coach">Life Coach</option>
                            <option value="business-coach">Business Coach</option>
                            <option value="fitness-coach">Fitness Coach</option>
                        </select>
                    </div>
                    <button id="create-offer-btn" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Create New Offer</button>
                </div>

                <div id="offers-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Offer cards will be added here -->
                    <div style="text-align: center; grid-column: 1 / -1; padding: 20px;">
                        No offers found. Create your first offer to get started.
                    </div>
                </div>
            </div>

            <!-- Create Offer Modal -->
            <div id="create-offer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; width: 80%; max-width: 600px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                    <h2>Create New Offer</h2>
                    <form id="create-offer-form" style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label for="offer-name" style="display: block; margin-bottom: 5px; font-weight: bold;">Offer Name:</label>
                            <input type="text" id="offer-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="offer-niche" style="display: block; margin-bottom: 5px; font-weight: bold;">Niche:</label>
                            <select id="offer-niche" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select a niche</option>
                                <option value="health-coach">Health Coach</option>
                                <option value="life-coach">Life Coach</option>
                                <option value="business-coach">Business Coach</option>
                                <option value="fitness-coach">Fitness Coach</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="offer-headline" style="display: block; margin-bottom: 5px; font-weight: bold;">Headline:</label>
                            <input type="text" id="offer-headline" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="offer-description" style="display: block; margin-bottom: 5px; font-weight: bold;">Description:</label>
                            <textarea id="offer-description" rows="4" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="offer-cta" style="display: block; margin-bottom: 5px; font-weight: bold;">Call to Action:</label>
                            <input type="text" id="offer-cta" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="offer-target" style="display: block; margin-bottom: 5px; font-weight: bold;">Target Audience:</label>
                            <select id="offer-target" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select target audience</option>
                                <option value="all">All Users</option>
                                <option value="quiz_completed">Quiz Completers</option>
                                <option value="high_score">High Quiz Score</option>
                                <option value="returning">Returning Users</option>
                            </select>
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="cancel-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                            <button type="submit" style="padding: 8px 16px; background-color: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Offer</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Create Split Test Modal -->
            <div id="create-test-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; width: 80%; max-width: 800px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                    <h2>Create New Split Test</h2>
                    <form id="create-test-form" style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label for="test-name" style="display: block; margin-bottom: 5px; font-weight: bold;">Test Name:</label>
                            <input type="text" id="test-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="test-niche" style="display: block; margin-bottom: 5px; font-weight: bold;">Niche:</label>
                            <select id="test-niche" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select a niche</option>
                                <option value="health-coach">Health Coach</option>
                                <option value="life-coach">Life Coach</option>
                                <option value="business-coach">Business Coach</option>
                                <option value="fitness-coach">Fitness Coach</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="test-target" style="display: block; margin-bottom: 5px; font-weight: bold;">Target Audience:</label>
                            <select id="test-target" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select target audience</option>
                                <option value="all">All Users</option>
                                <option value="quiz_completed">Quiz Completers</option>
                                <option value="high_score">High Quiz Score</option>
                                <option value="returning">Returning Users</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="test-duration" style="display: block; margin-bottom: 5px; font-weight: bold;">Test Duration (days):</label>
                            <input type="number" id="test-duration" min="1" max="90" value="14" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>

                        <h3 style="margin-top: 20px;">Test Variants</h3>
                        <div id="test-variants" style="margin-bottom: 15px;">
                            <div class="variant" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                                <h4>Variant A (Control)</h4>
                                <div style="margin-bottom: 10px;">
                                    <label for="variant-a-offer" style="display: block; margin-bottom: 5px;">Select Offer:</label>
                                    <select id="variant-a-offer" class="variant-offer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select an offer</option>
                                        <!-- Offers will be populated dynamically -->
                                    </select>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label for="variant-a-weight" style="display: block; margin-bottom: 5px;">Traffic Weight (%):</label>
                                    <input type="number" id="variant-a-weight" class="variant-weight" min="1" max="100" value="50" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>

                            <div class="variant" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                                <h4>Variant B</h4>
                                <div style="margin-bottom: 10px;">
                                    <label for="variant-b-offer" style="display: block; margin-bottom: 5px;">Select Offer:</label>
                                    <select id="variant-b-offer" class="variant-offer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select an offer</option>
                                        <!-- Offers will be populated dynamically -->
                                    </select>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label for="variant-b-weight" style="display: block; margin-bottom: 5px;">Traffic Weight (%):</label>
                                    <input type="number" id="variant-b-weight" class="variant-weight" min="1" max="100" value="50" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                        </div>

                        <button type="button" id="add-variant-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">+ Add Another Variant</button>

                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="cancel-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                            <button type="submit" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Start Split Test</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View Test Results Modal -->
            <div id="test-results-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: relative; width: 90%; max-width: 1000px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                    <h2 id="test-results-title">Split Test Results</h2>
                    <div id="test-results-content" style="margin-top: 20px;">
                        <p>Loading test results...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Supabase API details
        const SUPABASE_URL = 'https://eumhqssfvkyuepyrtlqj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bWhxc3Nmdmt5dWVweXJ0bHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NjE0MDEsImV4cCI6MjA2MjEzNzQwMX0.w-UzQq1G6GIinBdlIcW34KBSoeaAK-knNs4AvL8ct64';

        // Function to fetch data from Supabase
        async function fetchFromSupabase(table, query = '') {
            try {
                console.log(`Fetching from ${table}${query ? ' with query ' + query : ''}...`);

                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`Fetched ${data.length} items from ${table}`);

                return data;
            } catch (error) {
                console.error(`Error fetching from ${table}: ${error.message}`);
                return [];
            }
        }

        // Count unique users in data
        function countUniqueUsers(data) {
            const uniqueUsers = new Set();
            data.forEach(item => {
                if (item.user_id) {
                    uniqueUsers.add(item.user_id);
                }
            });
            return uniqueUsers.size;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Set up navigation
        function setupNavigation() {
            const navLinks = document.querySelectorAll('nav a');
            const sections = document.querySelectorAll('.dashboard-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Get target section ID from href
                    const targetId = this.getAttribute('href').substring(1);

                    // Hide all sections
                    sections.forEach(section => {
                        section.classList.remove('active');
                    });

                    // Show target section
                    document.getElementById(targetId).classList.add('active');

                    // Update active nav link
                    navLinks.forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        // Create charts
        function createCharts(pageViews, quizSubmissions, applicationSubmissions = []) {
            try {
                console.log('Creating charts...');

                // Traffic Source Chart
                const trafficSourcesMap = {};
                pageViews.forEach(view => {
                    const source = view.traffic_source || 'Unknown';
                    trafficSourcesMap[source] = (trafficSourcesMap[source] || 0) + 1;
                });

                const trafficSourceLabels = Object.keys(trafficSourcesMap);
                const trafficSourceData = Object.values(trafficSourcesMap);

                const trafficSourceCtx = document.getElementById('traffic-source-chart').getContext('2d');
                new Chart(trafficSourceCtx, {
                    type: 'bar',
                    data: {
                        labels: trafficSourceLabels,
                        datasets: [{
                            label: 'Page Views by Source',
                            data: trafficSourceData,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Niche Conversion Chart
                const nicheMap = {};
                quizSubmissions.forEach(submission => {
                    const niche = submission.niche || 'Unknown';
                    nicheMap[niche] = (nicheMap[niche] || 0) + 1;
                });

                const nicheLabels = Object.keys(nicheMap);
                const nicheData = Object.values(nicheMap);

                const nicheCtx = document.getElementById('niche-conversion-chart').getContext('2d');
                new Chart(nicheCtx, {
                    type: 'pie',
                    data: {
                        labels: nicheLabels,
                        datasets: [{
                            label: 'Submissions by Niche',
                            data: nicheData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                console.log('Charts created successfully');
            } catch (error) {
                console.error('Error creating charts:', error);
            }
        }

        // Get date filter query
        function getDateFilterQuery(dateRange) {
            if (dateRange === 'all') {
                return '';
            }

            const now = new Date();
            let startDate;

            if (dateRange === '7days') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
            } else if (dateRange === '30days') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 30);
            } else if (dateRange === '90days') {
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 90);
            } else {
                return '';
            }

            return `&timestamp=gte.${startDate.toISOString()}`;
        }

        // Get niche filter query
        function getNicheFilterQuery(niche) {
            if (niche === 'all') {
                return '';
            }

            return `&niche=eq.${niche}`;
        }

        // Populate niche filter
        async function populateNicheFilter() {
            try {
                // Fetch all niches from quiz submissions
                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', '?select=niche');

                // Extract unique niches
                const niches = new Set();
                quizSubmissions.forEach(submission => {
                    if (submission.niche) {
                        niches.add(submission.niche);
                    }
                });

                // Populate niche filter
                const nicheFilter = document.getElementById('niche-filter');
                niches.forEach(niche => {
                    const option = document.createElement('option');
                    option.value = niche;
                    option.textContent = niche.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    nicheFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating niche filter:', error);
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.getElementById('total-visitors').textContent = 'Loading...';
                document.getElementById('quiz-starts').textContent = 'Loading...';
                document.getElementById('quiz-completions').textContent = 'Loading...';
                document.getElementById('quiz-submissions').textContent = 'Loading...';
                document.getElementById('application-submissions').textContent = 'Loading...';

                // Get filter values
                const dateRange = document.getElementById('date-range').value;
                const niche = document.getElementById('niche-filter').value;

                // Build filter queries
                const dateFilterQuery = getDateFilterQuery(dateRange);
                const nicheFilterQuery = getNicheFilterQuery(niche);

                // Fetch page views
                const pageViews = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.page_view${dateFilterQuery}${nicheFilterQuery}`);
                document.getElementById('total-visitors').textContent = countUniqueUsers(pageViews);

                // Fetch quiz starts
                const quizStarts = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.quiz_started${dateFilterQuery}${nicheFilterQuery}`);
                document.getElementById('quiz-starts').textContent = countUniqueUsers(quizStarts);

                // Fetch quiz completions
                const quizCompletions = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.quiz_completed${dateFilterQuery}${nicheFilterQuery}`);
                document.getElementById('quiz-completions').textContent = countUniqueUsers(quizCompletions);

                // Fetch application submissions
                const applicationSubmissions = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.form_submitted&page_type=eq.application${dateFilterQuery}${nicheFilterQuery}`);
                document.getElementById('application-submissions').textContent = applicationSubmissions.length;

                // Fetch quiz submissions
                let submissionsQuery = '?select=*&order=created_at.desc';
                if (niche !== 'all') {
                    submissionsQuery += `&niche=eq.${niche}`;
                }
                if (dateRange !== 'all') {
                    const dateFilter = getDateFilterQuery(dateRange).replace('&timestamp=', '&created_at=');
                    submissionsQuery += dateFilter;
                }

                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', submissionsQuery);
                document.getElementById('quiz-submissions').textContent = quizSubmissions.length;

                // Populate submissions table
                const tableBody = document.querySelector('#submissions-table tbody');
                if (quizSubmissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">No submissions found</td></tr>';
                } else {
                    tableBody.innerHTML = quizSubmissions.slice(0, 10).map(submission => `
                        <tr>
                            <td>${submission.first_name} ${submission.last_name}</td>
                            <td>${submission.business_name || 'N/A'}</td>
                            <td>${submission.niche || 'N/A'}</td>
                            <td>${submission.total_score || 'N/A'}</td>
                            <td>${submission.primary_outcome_hint || 'N/A'}</td>
                            <td>${formatDate(submission.created_at)}</td>
                        </tr>
                    `).join('');
                }

                // Create charts
                createCharts(pageViews, quizSubmissions, applicationSubmissions);
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                document.getElementById('total-visitors').textContent = 'Error';
                document.getElementById('quiz-starts').textContent = 'Error';
                document.getElementById('quiz-completions').textContent = 'Error';
                document.getElementById('quiz-submissions').textContent = 'Error';
                document.getElementById('application-submissions').textContent = 'Error';
            }
        }

        // Create funnel chart
        async function createFunnelChart() {
            try {
                console.log('Creating funnel chart...');

                // Fetch data for funnel
                const pageViews = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.page_view');
                const quizStarts = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.quiz_started');
                const quizCompletions = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.quiz_completed');
                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', '?select=*');

                const pageViewCount = countUniqueUsers(pageViews);
                const quizStartCount = countUniqueUsers(quizStarts);
                const quizCompletionCount = countUniqueUsers(quizCompletions);
                const quizSubmissionCount = quizSubmissions.length;

                // Create funnel chart
                const funnelCtx = document.getElementById('funnel-chart').getContext('2d');
                new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Page Views', 'Quiz Starts', 'Quiz Completions', 'Submissions'],
                        datasets: [{
                            label: 'User Funnel',
                            data: [pageViewCount, quizStartCount, quizCompletionCount, quizSubmissionCount],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(255, 99, 132, 0.5)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Update journey stats
                const journeyStats = document.getElementById('journey-stats');
                journeyStats.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Page Views to Quiz Starts:</strong>
                        ${quizStartCount > 0 && pageViewCount > 0 ?
                            Math.round((quizStartCount / pageViewCount) * 100) + '%' :
                            'N/A'}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Quiz Starts to Completions:</strong>
                        ${quizCompletionCount > 0 && quizStartCount > 0 ?
                            Math.round((quizCompletionCount / quizStartCount) * 100) + '%' :
                            'N/A'}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Completions to Submissions:</strong>
                        ${quizSubmissionCount > 0 && quizCompletionCount > 0 ?
                            Math.round((quizSubmissionCount / quizCompletionCount) * 100) + '%' :
                            'N/A'}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Overall Conversion Rate:</strong>
                        ${quizSubmissionCount > 0 && pageViewCount > 0 ?
                            Math.round((quizSubmissionCount / pageViewCount) * 100) + '%' :
                            'N/A'}
                    </div>
                `;

                // Create user journeys visualization
                await createUserJourneys();

                console.log('Funnel chart created successfully');
            } catch (error) {
                console.error('Error creating funnel chart:', error);
                document.getElementById('funnel-chart').parentElement.innerHTML = '<p>Error loading funnel chart</p>';
                document.getElementById('journey-stats').innerHTML = '<p>Error loading journey statistics</p>';
            }
        }

        // Create user journeys visualization
        async function createUserJourneys() {
            try {
                console.log('Creating user journeys visualization...');

                // Fetch all user behavior data
                const userData = await fetchFromSupabase('tctc_user_behavior', '?select=*&order=timestamp.asc');

                // Group by user_id
                const journeys = {};
                userData.forEach(event => {
                    if (!event.user_id) return;

                    if (!journeys[event.user_id]) {
                        journeys[event.user_id] = [];
                    }
                    journeys[event.user_id].push(event);
                });

                // Create user journey visualization
                const userJourneysContainer = document.getElementById('user-journeys');

                if (Object.keys(journeys).length === 0) {
                    userJourneysContainer.innerHTML = '<p>No user journeys found</p>';
                    return;
                }

                // Take the first 5 journeys for visualization
                const journeyKeys = Object.keys(journeys).slice(0, 5);

                let journeysHTML = '<div style="overflow-x: auto;">';
                journeyKeys.forEach(userId => {
                    const events = journeys[userId];

                    journeysHTML += `
                        <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                            <h3>User ${userId.substring(0, 8)}...</h3>
                            <div style="display: flex; margin-top: 10px;">
                    `;

                    events.forEach((event, index) => {
                        const eventType = event.event_type;
                        let color = '#ccc';
                        let icon = '●';

                        if (eventType === 'page_view') {
                            color = '#3b82f6';
                            icon = '👁️';
                        } else if (eventType === 'quiz_started') {
                            color = '#10b981';
                            icon = '🏁';
                        } else if (eventType === 'quiz_completed') {
                            color = '#f59e0b';
                            icon = '✅';
                        } else if (eventType === 'form_submitted') {
                            color = '#ef4444';
                            icon = '📝';
                        }

                        journeysHTML += `
                            <div style="display: flex; flex-direction: column; align-items: center; margin-right: 20px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${color}; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px;">
                                    ${icon}
                                </div>
                                <div style="font-size: 12px; margin-top: 5px;">${eventType.replace('_', ' ')}</div>
                                <div style="font-size: 10px; color: #666;">${new Date(event.timestamp).toLocaleTimeString()}</div>
                            </div>
                        `;

                        if (index < events.length - 1) {
                            journeysHTML += `
                                <div style="display: flex; align-items: center; margin-right: 20px;">
                                    <div style="height: 2px; width: 30px; background-color: #ddd;"></div>
                                </div>
                            `;
                        }
                    });

                    journeysHTML += `
                            </div>
                        </div>
                    `;
                });

                journeysHTML += '</div>';
                userJourneysContainer.innerHTML = journeysHTML;

                console.log('User journeys visualization created successfully');
            } catch (error) {
                console.error('Error creating user journeys visualization:', error);
                document.getElementById('user-journeys').innerHTML = '<p>Error loading user journeys</p>';
            }
        }

        // Create quiz analytics
        async function createQuizAnalytics() {
            try {
                console.log('Creating quiz analytics...');

                // Fetch quiz submissions
                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', '?select=*');

                if (quizSubmissions.length === 0) {
                    document.getElementById('quiz-niche-chart').parentElement.innerHTML = '<p>No quiz submissions found</p>';
                    document.getElementById('quiz-score-chart').parentElement.innerHTML = '<p>No quiz submissions found</p>';
                    document.getElementById('question-analysis').innerHTML = '<p>No quiz submissions found</p>';
                    return;
                }

                // Create niche chart
                const nicheMap = {};
                quizSubmissions.forEach(submission => {
                    const niche = submission.niche || 'Unknown';
                    nicheMap[niche] = (nicheMap[niche] || 0) + 1;
                });

                const nicheLabels = Object.keys(nicheMap);
                const nicheData = Object.values(nicheMap);

                const nicheCtx = document.getElementById('quiz-niche-chart').getContext('2d');
                new Chart(nicheCtx, {
                    type: 'pie',
                    data: {
                        labels: nicheLabels,
                        datasets: [{
                            label: 'Submissions by Niche',
                            data: nicheData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Create score distribution chart
                const scoreMap = {
                    '0-5': 0,
                    '6-10': 0,
                    '11-15': 0,
                    '16-20': 0,
                    '21-25': 0
                };

                quizSubmissions.forEach(submission => {
                    const score = submission.total_score || 0;

                    if (score <= 5) {
                        scoreMap['0-5']++;
                    } else if (score <= 10) {
                        scoreMap['6-10']++;
                    } else if (score <= 15) {
                        scoreMap['11-15']++;
                    } else if (score <= 20) {
                        scoreMap['16-20']++;
                    } else {
                        scoreMap['21-25']++;
                    }
                });

                const scoreLabels = Object.keys(scoreMap);
                const scoreData = Object.values(scoreMap);

                const scoreCtx = document.getElementById('quiz-score-chart').getContext('2d');
                new Chart(scoreCtx, {
                    type: 'bar',
                    data: {
                        labels: scoreLabels,
                        datasets: [{
                            label: 'Score Distribution',
                            data: scoreData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Create question analysis
                const questionAnalysisContainer = document.getElementById('question-analysis');

                // Extract questions and answers
                const questionMap = {};

                quizSubmissions.forEach(submission => {
                    if (!submission.quiz_answers || !Array.isArray(submission.quiz_answers)) return;

                    submission.quiz_answers.forEach(qa => {
                        if (!qa.question || qa.question === 'Growth stifler question') return;

                        if (!questionMap[qa.question]) {
                            questionMap[qa.question] = {
                                answers: {},
                                totalResponses: 0
                            };
                        }

                        if (qa.answer) {
                            questionMap[qa.question].answers[qa.answer] = (questionMap[qa.question].answers[qa.answer] || 0) + 1;
                            questionMap[qa.question].totalResponses++;
                        }
                    });
                });

                // Create question analysis HTML
                let questionAnalysisHTML = '';

                Object.keys(questionMap).forEach(question => {
                    const answers = questionMap[question].answers;
                    const totalResponses = questionMap[question].totalResponses;

                    questionAnalysisHTML += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin-bottom: 10px;">${question}</h3>
                            <div style="margin-bottom: 15px;">
                                <strong>Total Responses:</strong> ${totalResponses}
                            </div>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Answer</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Count</th>
                                        <th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    Object.keys(answers).forEach(answer => {
                        const count = answers[answer];
                        const percentage = Math.round((count / totalResponses) * 100);

                        questionAnalysisHTML += `
                            <tr>
                                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">${answer}</td>
                                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">${count}</td>
                                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #eee;">${percentage}%</td>
                            </tr>
                        `;
                    });

                    questionAnalysisHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });

                questionAnalysisContainer.innerHTML = questionAnalysisHTML || '<p>No question data available</p>';

                console.log('Quiz analytics created successfully');
            } catch (error) {
                console.error('Error creating quiz analytics:', error);
                document.getElementById('quiz-niche-chart').parentElement.innerHTML = '<p>Error loading quiz niche chart</p>';
                document.getElementById('quiz-score-chart').parentElement.innerHTML = '<p>Error loading quiz score chart</p>';
                document.getElementById('question-analysis').innerHTML = '<p>Error loading question analysis</p>';
            }
        }

        // Create application analytics
        async function createApplicationAnalytics() {
            try {
                console.log('Creating application analytics...');

                // Get filter values
                const dateRange = document.getElementById('date-range').value;
                const niche = document.getElementById('niche-filter').value;

                // Build filter queries
                const dateFilterQuery = getDateFilterQuery(dateRange);
                const nicheFilterQuery = getNicheFilterQuery(niche);

                // Fetch all data needed for analysis
                const pageViews = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.page_view${dateFilterQuery}${nicheFilterQuery}`);
                const quizStarts = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.quiz_started${dateFilterQuery}${nicheFilterQuery}`);
                const quizCompletions = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.quiz_completed${dateFilterQuery}${nicheFilterQuery}`);
                const applicationSubmissions = await fetchFromSupabase('tctc_user_behavior', `?select=*&event_type=eq.form_submitted&page_type=eq.application${dateFilterQuery}${nicheFilterQuery}&order=timestamp.desc`);

                if (applicationSubmissions.length === 0) {
                    document.getElementById('applications-niche-chart').parentElement.innerHTML = '<p>No application submissions found</p>';
                    document.getElementById('applications-time-chart').parentElement.innerHTML = '<p>No application submissions found</p>';
                    document.getElementById('applications-source-chart').parentElement.innerHTML = '<p>No application submissions found</p>';
                    document.getElementById('conversion-rate-chart').parentElement.innerHTML = '<p>No application submissions found</p>';
                    document.getElementById('applications-table').querySelector('tbody').innerHTML = '<tr><td colspan="7">No application submissions found</td></tr>';

                    // Update funnel
                    document.getElementById('funnel-visitors').textContent = countUniqueUsers(pageViews);
                    document.getElementById('funnel-quiz-starts').textContent = countUniqueUsers(quizStarts);
                    document.getElementById('funnel-quiz-completions').textContent = countUniqueUsers(quizCompletions);
                    document.getElementById('funnel-applications').textContent = '0';

                    // Calculate rates
                    const visitors = countUniqueUsers(pageViews);
                    const starts = countUniqueUsers(quizStarts);
                    const completions = countUniqueUsers(quizCompletions);

                    document.getElementById('funnel-quiz-starts-rate').textContent =
                        visitors > 0 ? Math.round((starts / visitors) * 100) + '%' : '0%';
                    document.getElementById('funnel-quiz-completions-rate').textContent =
                        starts > 0 ? Math.round((completions / starts) * 100) + '%' : '0%';
                    document.getElementById('funnel-applications-rate').textContent = '0%';

                    return;
                }

                // Create applications by niche chart
                const nicheMap = {};
                applicationSubmissions.forEach(submission => {
                    const niche = submission.niche || 'Unknown';
                    nicheMap[niche] = (nicheMap[niche] || 0) + 1;
                });

                const nicheLabels = Object.keys(nicheMap);
                const nicheData = Object.values(nicheMap);

                const nicheCtx = document.getElementById('applications-niche-chart').getContext('2d');
                new Chart(nicheCtx, {
                    type: 'pie',
                    data: {
                        labels: nicheLabels,
                        datasets: [{
                            label: 'Applications by Niche',
                            data: nicheData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Create applications over time chart
                // Group by day
                const timeMap = {};
                applicationSubmissions.forEach(submission => {
                    const date = new Date(submission.timestamp);
                    const dateString = date.toISOString().split('T')[0];
                    timeMap[dateString] = (timeMap[dateString] || 0) + 1;
                });

                // Sort dates
                const sortedDates = Object.keys(timeMap).sort();
                const timeData = sortedDates.map(date => timeMap[date]);

                // Format dates for display
                const formattedDates = sortedDates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString();
                });

                const timeCtx = document.getElementById('applications-time-chart').getContext('2d');
                new Chart(timeCtx, {
                    type: 'line',
                    data: {
                        labels: formattedDates,
                        datasets: [{
                            label: 'Applications Over Time',
                            data: timeData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // Create applications by source chart
                const sourceMap = {};
                applicationSubmissions.forEach(submission => {
                    const source = submission.traffic_source || 'Unknown';
                    sourceMap[source] = (sourceMap[source] || 0) + 1;
                });

                const sourceLabels = Object.keys(sourceMap);
                const sourceData = Object.values(sourceMap);

                const sourceCtx = document.getElementById('applications-source-chart').getContext('2d');
                new Chart(sourceCtx, {
                    type: 'bar',
                    data: {
                        labels: sourceLabels,
                        datasets: [{
                            label: 'Applications by Source',
                            data: sourceData,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // Create conversion rate chart
                const conversionCtx = document.getElementById('conversion-rate-chart').getContext('2d');

                // Calculate conversion rates
                const visitors = countUniqueUsers(pageViews);
                const starts = countUniqueUsers(quizStarts);
                const completions = countUniqueUsers(quizCompletions);
                const applications = applicationSubmissions.length;

                const viewToStartRate = visitors > 0 ? (starts / visitors) * 100 : 0;
                const startToCompletionRate = starts > 0 ? (completions / starts) * 100 : 0;
                const completionToApplicationRate = completions > 0 ? (applications / completions) * 100 : 0;
                const overallConversionRate = visitors > 0 ? (applications / visitors) * 100 : 0;

                new Chart(conversionCtx, {
                    type: 'bar',
                    data: {
                        labels: ['View → Start', 'Start → Completion', 'Completion → Application', 'Overall'],
                        datasets: [{
                            label: 'Conversion Rate (%)',
                            data: [
                                viewToStartRate.toFixed(2),
                                startToCompletionRate.toFixed(2),
                                completionToApplicationRate.toFixed(2),
                                overallConversionRate.toFixed(2)
                            ],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(255, 99, 132, 0.5)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Conversion Rate (%)'
                                }
                            }
                        }
                    }
                });

                // Update funnel
                document.getElementById('funnel-visitors').textContent = visitors;
                document.getElementById('funnel-quiz-starts').textContent = starts;
                document.getElementById('funnel-quiz-completions').textContent = completions;
                document.getElementById('funnel-applications').textContent = applications;

                // Update rates
                document.getElementById('funnel-quiz-starts-rate').textContent = viewToStartRate.toFixed(1) + '%';
                document.getElementById('funnel-quiz-completions-rate').textContent = startToCompletionRate.toFixed(1) + '%';
                document.getElementById('funnel-applications-rate').textContent = completionToApplicationRate.toFixed(1) + '%';

                // Populate applications table
                const tableBody = document.querySelector('#applications-table tbody');
                tableBody.innerHTML = applicationSubmissions.slice(0, 10).map(submission => {
                    // Extract page URL from event_data if available
                    let pageUrl = 'N/A';
                    if (submission.event_data && submission.event_data.page_url) {
                        pageUrl = submission.event_data.page_url;
                        // Truncate long URLs
                        if (pageUrl.length > 30) {
                            pageUrl = pageUrl.substring(0, 30) + '...';
                        }
                    }

                    return `
                    <tr>
                        <td>${formatDate(submission.timestamp)}</td>
                        <td>${submission.user_id || 'N/A'}</td>
                        <td>${submission.niche || 'N/A'}</td>
                        <td>${submission.traffic_source || 'N/A'}</td>
                        <td title="${submission.event_data?.page_url || ''}">${pageUrl}</td>
                        <td><span class="status-badge" style="background-color: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Submitted</span></td>
                        <td>
                            <button class="view-user-btn" data-user-id="${submission.user_id}" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">View User</button>
                        </td>
                    </tr>
                    `;
                }).join('');

                // Add event listeners to view user buttons
                document.querySelectorAll('.view-user-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        showUserDetails(userId);
                    });
                });

                console.log('Application analytics created successfully');
            } catch (error) {
                console.error('Error creating application analytics:', error);
                document.getElementById('applications-niche-chart').parentElement.innerHTML = '<p>Error loading applications by niche chart</p>';
                document.getElementById('applications-time-chart').parentElement.innerHTML = '<p>Error loading applications over time chart</p>';
                document.getElementById('applications-source-chart').parentElement.innerHTML = '<p>Error loading applications by source chart</p>';
                document.getElementById('conversion-rate-chart').parentElement.innerHTML = '<p>Error loading conversion rate chart</p>';
                document.getElementById('applications-table').querySelector('tbody').innerHTML = '<tr><td colspan="7">Error loading application submissions</td></tr>';
            }
        }

        // Create user analytics
        async function createUserAnalytics() {
            try {
                console.log('Creating user analytics...');

                // Get filter values
                const dateRange = document.getElementById('date-range').value;
                const niche = document.getElementById('niche-filter').value;

                // Build filter queries
                const dateFilterQuery = getDateFilterQuery(dateRange);
                const nicheFilterQuery = getNicheFilterQuery(niche);

                // Fetch all user behavior data
                const userData = await fetchFromSupabase('tctc_user_behavior', `?select=*${dateFilterQuery}${nicheFilterQuery}&order=timestamp.asc`);

                if (userData.length === 0) {
                    document.getElementById('users-niche-chart').parentElement.innerHTML = '<p>No user data found</p>';
                    document.getElementById('users-source-chart').parentElement.innerHTML = '<p>No user data found</p>';
                    document.getElementById('user-engagement-chart').parentElement.innerHTML = '<p>No user data found</p>';
                    document.getElementById('user-retention-chart').parentElement.innerHTML = '<p>No user data found</p>';
                    document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">No user data found</td></tr>';
                    return;
                }

                // Group data by user
                const userMap = {};
                userData.forEach(event => {
                    if (!event.user_id) return;

                    if (!userMap[event.user_id]) {
                        userMap[event.user_id] = {
                            userId: event.user_id,
                            events: [],
                            firstSeen: event.timestamp,
                            lastSeen: event.timestamp,
                            niche: event.niche || 'Unknown',
                            trafficSource: event.traffic_source || 'Unknown',
                            quizStarted: false,
                            quizCompleted: false,
                            applicationSubmitted: false
                        };
                    }

                    // Update user data
                    userMap[event.user_id].events.push(event);
                    userMap[event.user_id].lastSeen = event.timestamp > userMap[event.user_id].lastSeen ? event.timestamp : userMap[event.user_id].lastSeen;

                    // Update event flags
                    if (event.event_type === 'quiz_started') {
                        userMap[event.user_id].quizStarted = true;
                    } else if (event.event_type === 'quiz_completed') {
                        userMap[event.user_id].quizCompleted = true;
                    } else if (event.event_type === 'form_submitted' && event.page_type === 'application') {
                        userMap[event.user_id].applicationSubmitted = true;
                    }

                    // Update niche and traffic source if available
                    if (event.niche) {
                        userMap[event.user_id].niche = event.niche;
                    }
                    if (event.traffic_source) {
                        userMap[event.user_id].trafficSource = event.traffic_source;
                    }
                });

                // Convert to array
                const users = Object.values(userMap);

                // Create users by niche chart
                const nicheMap = {};
                users.forEach(user => {
                    const niche = user.niche;
                    nicheMap[niche] = (nicheMap[niche] || 0) + 1;
                });

                const nicheLabels = Object.keys(nicheMap);
                const nicheData = Object.values(nicheMap);

                const nicheCtx = document.getElementById('users-niche-chart').getContext('2d');
                new Chart(nicheCtx, {
                    type: 'pie',
                    data: {
                        labels: nicheLabels,
                        datasets: [{
                            label: 'Users by Niche',
                            data: nicheData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Create users by source chart
                const sourceMap = {};
                users.forEach(user => {
                    const source = user.trafficSource;
                    sourceMap[source] = (sourceMap[source] || 0) + 1;
                });

                const sourceLabels = Object.keys(sourceMap);
                const sourceData = Object.values(sourceMap);

                const sourceCtx = document.getElementById('users-source-chart').getContext('2d');
                new Chart(sourceCtx, {
                    type: 'bar',
                    data: {
                        labels: sourceLabels,
                        datasets: [{
                            label: 'Users by Source',
                            data: sourceData,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // Create user engagement chart
                const engagementCtx = document.getElementById('user-engagement-chart').getContext('2d');

                // Calculate engagement metrics
                const totalUsers = users.length;
                const quizStartedUsers = users.filter(user => user.quizStarted).length;
                const quizCompletedUsers = users.filter(user => user.quizCompleted).length;
                const applicationSubmittedUsers = users.filter(user => user.applicationSubmitted).length;

                new Chart(engagementCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Total Users', 'Quiz Started', 'Quiz Completed', 'Application Submitted'],
                        datasets: [{
                            label: 'User Engagement',
                            data: [totalUsers, quizStartedUsers, quizCompletedUsers, applicationSubmittedUsers],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(255, 99, 132, 0.5)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // Create user retention chart
                const retentionCtx = document.getElementById('user-retention-chart').getContext('2d');

                // Calculate retention metrics (users with multiple sessions)
                const userSessions = {};
                userData.forEach(event => {
                    if (!event.user_id) return;

                    if (!userSessions[event.user_id]) {
                        userSessions[event.user_id] = new Set();
                    }

                    // Use date as session identifier (simple approach)
                    const sessionDate = new Date(event.timestamp).toISOString().split('T')[0];
                    userSessions[event.user_id].add(sessionDate);
                });

                const sessionCounts = {};
                Object.values(userSessions).forEach(sessions => {
                    const count = sessions.size;
                    sessionCounts[count] = (sessionCounts[count] || 0) + 1;
                });

                const sessionLabels = Object.keys(sessionCounts).sort((a, b) => a - b);
                const sessionData = sessionLabels.map(count => sessionCounts[count]);

                new Chart(retentionCtx, {
                    type: 'bar',
                    data: {
                        labels: sessionLabels.map(count => `${count} ${count === '1' ? 'Session' : 'Sessions'}`),
                        datasets: [{
                            label: 'Users by Session Count',
                            data: sessionData,
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });

                // Populate users table
                const tableBody = document.querySelector('#users-table tbody');
                tableBody.innerHTML = users.slice(0, 10).map(user => {
                    // Calculate number of sessions
                    const sessions = new Set();
                    user.events.forEach(event => {
                        const sessionDate = new Date(event.timestamp).toISOString().split('T')[0];
                        sessions.add(sessionDate);
                    });

                    // Determine quiz status
                    let quizStatus = 'Not Started';
                    let quizStatusColor = '#6b7280';

                    if (user.quizCompleted) {
                        quizStatus = 'Completed';
                        quizStatusColor = '#10b981';
                    } else if (user.quizStarted) {
                        quizStatus = 'Started';
                        quizStatusColor = '#f59e0b';
                    }

                    // Determine application status
                    let applicationStatus = 'Not Submitted';
                    let applicationStatusColor = '#6b7280';

                    if (user.applicationSubmitted) {
                        applicationStatus = 'Submitted';
                        applicationStatusColor = '#10b981';
                    }

                    return `
                    <tr>
                        <td>${user.userId}</td>
                        <td>${formatDate(user.firstSeen)}</td>
                        <td>${formatDate(user.lastSeen)}</td>
                        <td>${sessions.size}</td>
                        <td><span style="background-color: ${quizStatusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${quizStatus}</span></td>
                        <td><span style="background-color: ${applicationStatusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${applicationStatus}</span></td>
                        <td>${user.trafficSource}</td>
                        <td>
                            <button class="view-user-btn" data-user-id="${user.userId}" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">View Details</button>
                        </td>
                    </tr>
                    `;
                }).join('');

                // Add event listeners to view user buttons
                document.querySelectorAll('.view-user-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        showUserDetails(userId);
                    });
                });

                // Set up user search
                document.getElementById('user-search-btn').addEventListener('click', searchUsers);
                document.getElementById('user-search').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });

                // Set up user filter
                document.getElementById('user-filter').addEventListener('change', filterUsers);

                // Set up modal close button
                document.getElementById('close-modal-btn').addEventListener('click', function() {
                    document.getElementById('user-detail-modal').style.display = 'none';
                });

                console.log('User analytics created successfully');
            } catch (error) {
                console.error('Error creating user analytics:', error);
                document.getElementById('users-niche-chart').parentElement.innerHTML = '<p>Error loading users by niche chart</p>';
                document.getElementById('users-source-chart').parentElement.innerHTML = '<p>Error loading users by source chart</p>';
                document.getElementById('user-engagement-chart').parentElement.innerHTML = '<p>Error loading user engagement chart</p>';
                document.getElementById('user-retention-chart').parentElement.innerHTML = '<p>Error loading user retention chart</p>';
                document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">Error loading user data</td></tr>';
            }
        }

        // Search users
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.trim();
            if (!searchTerm) return;

            try {
                // Fetch user data matching the search term
                const userData = await fetchFromSupabase('tctc_user_behavior', `?select=*&user_id=ilike.%${searchTerm}%&order=timestamp.asc`);

                if (userData.length === 0) {
                    document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">No users found matching the search term</td></tr>';
                    return;
                }

                // Process and display the user data
                processAndDisplayUsers(userData);
            } catch (error) {
                console.error('Error searching users:', error);
                document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">Error searching users</td></tr>';
            }
        }

        // Filter users
        async function filterUsers() {
            const filterValue = document.getElementById('user-filter').value;
            if (filterValue === 'all') {
                // Reload all users
                await createUserAnalytics();
                return;
            }

            try {
                let userData;

                if (filterValue === 'quiz_completed') {
                    userData = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.quiz_completed&order=timestamp.asc');
                } else if (filterValue === 'application') {
                    userData = await fetchFromSupabase('tctc_user_behavior', '?select=*&event_type=eq.form_submitted&page_type=eq.application&order=timestamp.asc');
                } else if (filterValue === 'high_value') {
                    // For high value users, we need to identify users with multiple sessions
                    // This is a simplified approach - in a real system, you'd have more sophisticated criteria
                    const allUserData = await fetchFromSupabase('tctc_user_behavior', '?select=*&order=timestamp.asc');

                    // Group by user and count sessions
                    const userSessions = {};
                    allUserData.forEach(event => {
                        if (!event.user_id) return;

                        if (!userSessions[event.user_id]) {
                            userSessions[event.user_id] = new Set();
                        }

                        // Use date as session identifier
                        const sessionDate = new Date(event.timestamp).toISOString().split('T')[0];
                        userSessions[event.user_id].add(sessionDate);
                    });

                    // Filter users with multiple sessions
                    const highValueUserIds = Object.entries(userSessions)
                        .filter(([userId, sessions]) => sessions.size > 1)
                        .map(([userId]) => userId);

                    // If no high value users found
                    if (highValueUserIds.length === 0) {
                        document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">No high value users found</td></tr>';
                        return;
                    }

                    // Filter user data to only include high value users
                    userData = allUserData.filter(event => highValueUserIds.includes(event.user_id));
                }

                if (!userData || userData.length === 0) {
                    document.getElementById('users-table').querySelector('tbody').innerHTML = `<tr><td colspan="8">No users found matching the filter: ${filterValue}</td></tr>`;
                    return;
                }

                // Process and display the user data
                processAndDisplayUsers(userData);
            } catch (error) {
                console.error('Error filtering users:', error);
                document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="8">Error filtering users</td></tr>';
            }
        }

        // Process and display users
        function processAndDisplayUsers(userData) {
            // Group data by user
            const userMap = {};
            userData.forEach(event => {
                if (!event.user_id) return;

                if (!userMap[event.user_id]) {
                    userMap[event.user_id] = {
                        userId: event.user_id,
                        events: [],
                        firstSeen: event.timestamp,
                        lastSeen: event.timestamp,
                        niche: event.niche || 'Unknown',
                        trafficSource: event.traffic_source || 'Unknown',
                        quizStarted: false,
                        quizCompleted: false,
                        applicationSubmitted: false
                    };
                }

                // Update user data
                userMap[event.user_id].events.push(event);
                userMap[event.user_id].lastSeen = event.timestamp > userMap[event.user_id].lastSeen ? event.timestamp : userMap[event.user_id].lastSeen;

                // Update event flags
                if (event.event_type === 'quiz_started') {
                    userMap[event.user_id].quizStarted = true;
                } else if (event.event_type === 'quiz_completed') {
                    userMap[event.user_id].quizCompleted = true;
                } else if (event.event_type === 'form_submitted' && event.page_type === 'application') {
                    userMap[event.user_id].applicationSubmitted = true;
                }

                // Update niche and traffic source if available
                if (event.niche) {
                    userMap[event.user_id].niche = event.niche;
                }
                if (event.traffic_source) {
                    userMap[event.user_id].trafficSource = event.traffic_source;
                }
            });

            // Convert to array
            const users = Object.values(userMap);

            // Populate users table
            const tableBody = document.querySelector('#users-table tbody');

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8">No users found</td></tr>';
                return;
            }

            tableBody.innerHTML = users.map(user => {
                // Calculate number of sessions
                const sessions = new Set();
                user.events.forEach(event => {
                    const sessionDate = new Date(event.timestamp).toISOString().split('T')[0];
                    sessions.add(sessionDate);
                });

                // Determine quiz status
                let quizStatus = 'Not Started';
                let quizStatusColor = '#6b7280';

                if (user.quizCompleted) {
                    quizStatus = 'Completed';
                    quizStatusColor = '#10b981';
                } else if (user.quizStarted) {
                    quizStatus = 'Started';
                    quizStatusColor = '#f59e0b';
                }

                // Determine application status
                let applicationStatus = 'Not Submitted';
                let applicationStatusColor = '#6b7280';

                if (user.applicationSubmitted) {
                    applicationStatus = 'Submitted';
                    applicationStatusColor = '#10b981';
                }

                return `
                <tr>
                    <td>${user.userId}</td>
                    <td>${formatDate(user.firstSeen)}</td>
                    <td>${formatDate(user.lastSeen)}</td>
                    <td>${sessions.size}</td>
                    <td><span style="background-color: ${quizStatusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${quizStatus}</span></td>
                    <td><span style="background-color: ${applicationStatusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${applicationStatus}</span></td>
                    <td>${user.trafficSource}</td>
                    <td>
                        <button class="view-user-btn" data-user-id="${user.userId}" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">View Details</button>
                    </td>
                </tr>
                `;
            }).join('');

            // Add event listeners to view user buttons
            document.querySelectorAll('.view-user-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    showUserDetails(userId);
                });
            });
        }

        // Show user details
        async function showUserDetails(userId) {
            try {
                // Show modal
                document.getElementById('user-detail-modal').style.display = 'block';
                document.getElementById('user-journey-details').innerHTML = '<p>Loading user details...</p>';

                // Fetch user data
                const userData = await fetchFromSupabase('tctc_user_behavior', `?select=*&user_id=eq.${userId}&order=timestamp.asc`);

                if (userData.length === 0) {
                    document.getElementById('user-journey-details').innerHTML = '<p>No data found for this user</p>';
                    return;
                }

                // Fetch quiz submissions for this user
                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', `?select=*&user_id=eq.${userId}&order=created_at.desc`);

                // Create user journey visualization
                let journeyHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>User ID: ${userId}</h3>
                        <p><strong>First Seen:</strong> ${formatDate(userData[0].timestamp)}</p>
                        <p><strong>Last Seen:</strong> ${formatDate(userData[userData.length - 1].timestamp)}</p>
                        <p><strong>Traffic Source:</strong> ${userData[0].traffic_source || 'Unknown'}</p>
                        <p><strong>Niche:</strong> ${userData[0].niche || 'Unknown'}</p>
                    </div>

                    <h3>User Journey</h3>
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <div style="display: flex; margin-top: 10px;">
                `;

                // Add events to journey
                userData.forEach((event, index) => {
                    const eventType = event.event_type;
                    let color = '#ccc';
                    let icon = '●';

                    if (eventType === 'page_view') {
                        color = '#3b82f6';
                        icon = '👁️';
                    } else if (eventType === 'quiz_started') {
                        color = '#10b981';
                        icon = '🏁';
                    } else if (eventType === 'quiz_completed') {
                        color = '#f59e0b';
                        icon = '✅';
                    } else if (eventType === 'form_submitted') {
                        color = '#ef4444';
                        icon = '📝';
                    }

                    journeyHTML += `
                        <div style="display: flex; flex-direction: column; align-items: center; margin-right: 20px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${color}; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px;">
                                ${icon}
                            </div>
                            <div style="font-size: 12px; margin-top: 5px;">${eventType.replace('_', ' ')}</div>
                            <div style="font-size: 10px; color: #666;">${new Date(event.timestamp).toLocaleTimeString()}</div>
                            <div style="font-size: 10px; color: #666;">${event.page_type || ''}</div>
                        </div>
                    `;

                    if (index < userData.length - 1) {
                        journeyHTML += `
                            <div style="display: flex; align-items: center; margin-right: 20px;">
                                <div style="height: 2px; width: 30px; background-color: #ddd;"></div>
                            </div>
                        `;
                    }
                });

                journeyHTML += `
                        </div>
                    </div>
                `;

                // Add quiz submissions if available
                if (quizSubmissions.length > 0) {
                    journeyHTML += `
                        <h3>Quiz Submissions</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Date</th>
                                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Niche</th>
                                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Score</th>
                                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Outcome</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    quizSubmissions.forEach(submission => {
                        journeyHTML += `
                            <tr>
                                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">${formatDate(submission.created_at)}</td>
                                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">${submission.niche || 'N/A'}</td>
                                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">${submission.total_score || 'N/A'}</td>
                                <td style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">${submission.primary_outcome_hint || 'N/A'}</td>
                            </tr>
                        `;
                    });

                    journeyHTML += `
                            </tbody>
                        </table>
                    `;
                }

                // Update modal content
                document.getElementById('user-journey-details').innerHTML = journeyHTML;
            } catch (error) {
                console.error('Error showing user details:', error);
                document.getElementById('user-journey-details').innerHTML = '<p>Error loading user details</p>';
            }
        }

        // Initialize tabs
        async function initializeTabs() {
            const navLinks = document.querySelectorAll('nav a');

            navLinks.forEach(link => {
                link.addEventListener('click', async function(e) {
                    const targetId = this.getAttribute('href').substring(1);

                    // Load data for specific tabs when they're clicked
                    if (targetId === 'user-flow' && !document.getElementById('funnel-chart').chart) {
                        await createFunnelChart();
                    } else if (targetId === 'quiz-analytics' && !document.getElementById('quiz-niche-chart').chart) {
                        await createQuizAnalytics();
                    } else if (targetId === 'conversion' && !document.getElementById('applications-niche-chart').chart) {
                        await createApplicationAnalytics();
                    } else if (targetId === 'users' && !document.getElementById('users-niche-chart').chart) {
                        await createUserAnalytics();
                    }
                });
            });
        }

        // Set up filters
        function setupFilters() {
            const dateRangeFilter = document.getElementById('date-range');
            const nicheFilter = document.getElementById('niche-filter');
            const refreshButton = document.getElementById('refresh-btn');

            // Add event listeners
            dateRangeFilter.addEventListener('change', initializeDashboard);
            nicheFilter.addEventListener('change', initializeDashboard);
            refreshButton.addEventListener('click', initializeDashboard);

            // Set up auto-refresh
            let autoRefreshInterval = null;

            // Add auto-refresh toggle to the refresh button
            refreshButton.addEventListener('contextmenu', function(e) {
                e.preventDefault();

                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    refreshButton.textContent = 'Refresh Data';
                    alert('Auto-refresh disabled');
                } else {
                    autoRefreshInterval = setInterval(initializeDashboard, 60000); // Refresh every minute
                    refreshButton.textContent = 'Auto-Refreshing...';
                    alert('Auto-refresh enabled (every 60 seconds). Right-click to disable.');
                }
            });

            // Add tooltip to refresh button
            refreshButton.title = 'Left-click to refresh now. Right-click to toggle auto-refresh.';
        }

        // Add export functionality
        function setupExport() {
            // Add export button next to the refresh button
            const refreshButton = document.getElementById('refresh-btn');
            const exportButton = document.createElement('button');
            exportButton.id = 'export-btn';
            exportButton.textContent = 'Export Data';
            exportButton.style.padding = '5px 10px';
            exportButton.style.backgroundColor = '#10b981';
            exportButton.style.color = 'white';
            exportButton.style.border = 'none';
            exportButton.style.borderRadius = '4px';
            exportButton.style.cursor = 'pointer';
            exportButton.title = 'Export current data to CSV';

            refreshButton.parentNode.appendChild(exportButton);

            // Add event listener
            exportButton.addEventListener('click', exportData);
        }

        // Export data to CSV
        async function exportData() {
            try {
                // Get filter values
                const dateRange = document.getElementById('date-range').value;
                const niche = document.getElementById('niche-filter').value;

                // Build filter queries
                const dateFilterQuery = getDateFilterQuery(dateRange);
                const nicheFilterQuery = getNicheFilterQuery(niche);

                // Fetch quiz submissions
                let submissionsQuery = '?select=*&order=created_at.desc';
                if (niche !== 'all') {
                    submissionsQuery += `&niche=eq.${niche}`;
                }
                if (dateRange !== 'all') {
                    const dateFilter = getDateFilterQuery(dateRange).replace('&timestamp=', '&created_at=');
                    submissionsQuery += dateFilter;
                }

                const quizSubmissions = await fetchFromSupabase('tctc_quiz_submission', submissionsQuery);

                if (quizSubmissions.length === 0) {
                    alert('No data to export');
                    return;
                }

                // Create CSV content
                let csvContent = 'data:text/csv;charset=utf-8,';

                // Add headers
                const headers = ['First Name', 'Last Name', 'Business Name', 'Email', 'Niche', 'Score', 'Outcome', 'Date'];
                csvContent += headers.join(',') + '\\n';

                // Add rows
                quizSubmissions.forEach(submission => {
                    const row = [
                        `"${submission.first_name || ''}"`,
                        `"${submission.last_name || ''}"`,
                        `"${submission.business_name || ''}"`,
                        `"${submission.email || ''}"`,
                        `"${submission.niche || ''}"`,
                        submission.total_score || '',
                        `"${submission.primary_outcome_hint || ''}"`,
                        formatDate(submission.created_at)
                    ];
                    csvContent += row.join(',') + '\\n';
                });

                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `quiz-submissions-${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);

                // Trigger download
                link.click();

                // Clean up
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            setupNavigation();
            await populateNicheFilter();
            setupFilters();
            setupExport();
            initializeDashboard();
            initializeTabs();

            // Initialize the Offers & Split Tests tab when it's selected
            const offersTab = document.querySelector('a[href="#offers"]');
            if (offersTab) {
                offersTab.addEventListener('click', function() {
                    if (window.offersAndSplitTests && typeof window.offersAndSplitTests.initialize === 'function') {
                        window.offersAndSplitTests.initialize();
                    } else {
                        console.error('offersAndSplitTests.initialize function not found');
                    }
                });
            }
        });
    </script>

    <!-- Gemini AI Integration -->
    <script src="js/gemini-integration.js"></script>

    <!-- Offers & Split Tests JavaScript -->
    <script src="js/offers-split-tests.js"></script>

    <!-- Create Offer Modal -->
    <div id="create-offer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="position: relative; width: 80%; max-width: 600px; margin: 50px auto 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            <h2>Create New Offer</h2>
            <form id="create-offer-form">
                <div style="margin-bottom: 15px;">
                    <label for="offer-name" style="display: block; margin-bottom: 5px; font-weight: bold;">Offer Name:</label>
                    <input type="text" id="offer-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="offer-niche" style="display: block; margin-bottom: 5px; font-weight: bold;">Niche:</label>
                    <select id="offer-niche" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select a niche</option>
                        <option value="health-coach">Health Coach</option>
                        <option value="life-coach">Life Coach</option>
                        <option value="business-coach">Business Coach</option>
                        <option value="fitness-coach">Fitness Coach</option>
                        <option value="weight-loss-clinics">Weight Loss Clinics</option>
                        <option value="cosmetic-dentists">Cosmetic Dentists</option>
                        <option value="pmu-artists">PMU Artists</option>
                        <option value="high-end-chiropractors">High-End Chiropractors</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="offer-headline" style="display: block; margin-bottom: 5px; font-weight: bold;">Headline:</label>
                    <input type="text" id="offer-headline" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="offer-description" style="display: block; margin-bottom: 5px; font-weight: bold;">Description:</label>
                    <textarea id="offer-description" rows="4" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="offer-cta" style="display: block; margin-bottom: 5px; font-weight: bold;">CTA Text:</label>
                    <input type="text" id="offer-cta" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="offer-target" style="display: block; margin-bottom: 5px; font-weight: bold;">Target Audience:</label>
                    <select id="offer-target" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="all">All Users</option>
                        <option value="quiz_completed">Quiz Completers</option>
                        <option value="high_score">High Quiz Score</option>
                        <option value="returning">Returning Users</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="cancel-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                    <button type="submit" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Offer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Split Test Modal -->
    <div id="create-test-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="position: relative; width: 80%; max-width: 800px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            <h2>Create New Split Test</h2>
            <form id="create-test-form">
                <div style="margin-bottom: 15px;">
                    <label for="test-name" style="display: block; margin-bottom: 5px; font-weight: bold;">Test Name:</label>
                    <input type="text" id="test-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="test-niche" style="display: block; margin-bottom: 5px; font-weight: bold;">Niche:</label>
                    <select id="test-niche" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select a niche</option>
                        <option value="health-coach">Health Coach</option>
                        <option value="life-coach">Life Coach</option>
                        <option value="business-coach">Business Coach</option>
                        <option value="fitness-coach">Fitness Coach</option>
                        <option value="weight-loss-clinics">Weight Loss Clinics</option>
                        <option value="cosmetic-dentists">Cosmetic Dentists</option>
                        <option value="pmu-artists">PMU Artists</option>
                        <option value="high-end-chiropractors">High-End Chiropractors</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="test-target" style="display: block; margin-bottom: 5px; font-weight: bold;">Target Audience:</label>
                    <select id="test-target" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="all">All Users</option>
                        <option value="quiz_completed">Quiz Completers</option>
                        <option value="high_score">High Quiz Score</option>
                        <option value="returning">Returning Users</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="test-duration" style="display: block; margin-bottom: 5px; font-weight: bold;">Duration (days):</label>
                    <input type="number" id="test-duration" min="1" max="90" value="14" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <h3>Test Variants</h3>
                <div id="test-variants">
                    <div class="variant" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                        <h4>Variant A (Control)</h4>
                        <div style="margin-bottom: 10px;">
                            <label for="variant-a-offer" style="display: block; margin-bottom: 5px;">Select Offer:</label>
                            <select id="variant-a-offer" class="variant-offer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select an offer</option>
                                <!-- Offers will be populated dynamically -->
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="variant-a-weight" style="display: block; margin-bottom: 5px;">Traffic Weight (%):</label>
                            <input type="number" id="variant-a-weight" class="variant-weight" min="5" max="95" value="50" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>

                    <div class="variant" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                        <h4>Variant B</h4>
                        <div style="margin-bottom: 10px;">
                            <label for="variant-b-offer" style="display: block; margin-bottom: 5px;">Select Offer:</label>
                            <select id="variant-b-offer" class="variant-offer" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select an offer</option>
                                <!-- Offers will be populated dynamically -->
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="variant-b-weight" style="display: block; margin-bottom: 5px;">Traffic Weight (%):</label>
                            <input type="number" id="variant-b-weight" class="variant-weight" min="5" max="95" value="50" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button type="button" class="remove-variant-btn" style="padding: 5px 10px; background-color: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Variant</button>
                    </div>
                </div>

                <button type="button" id="add-variant-btn" style="padding: 8px 16px; background-color: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px;">Add Variant</button>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="cancel-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
                    <button type="submit" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Test</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="test-results-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="position: relative; width: 80%; max-width: 800px; margin: 50px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <button class="close-modal-btn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            <h2 id="test-results-title">Test Results</h2>
            <div id="test-results-content" style="margin-top: 20px;">
                <p>Loading test results...</p>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="close-modal-btn" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
